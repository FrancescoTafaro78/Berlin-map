<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Mappa Interattiva di Berlino</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó∫Ô∏è</text></svg>">
    
    <!-- LeafletJS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #FF6B6B;
            --food-cheap: #00b894;
            --food-mid: #fdcb6e;
            --attractions: #e17055;
            --text-color: #333;
            --light-text-color: #fff;
            --border-radius: 12px;
            --box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-color);
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        #app-container {
            display: flex;
            height: 100vh;
        }

        #sidebar {
            width: 400px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-in-out;
        }

        #sidebar-header {
            padding: 25px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--light-text-color);
            text-align: center;
        }

        #sidebar-header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        #sidebar-header p {
            margin: 8px 0 0;
            font-weight: 300;
            opacity: 0.9;
        }

        #nav {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        #nav button {
            background: none;
            border: none;
            padding: 12px 18px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6c757d;
            border-radius: 25px;
            position: relative;
        }

        #nav button.active, #nav button:hover {
            color: var(--light-text-color);
            transform: translateY(-2px);
        }

        #nav button.all.active, #nav button.all:hover {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        #nav button.food-cheap.active, #nav button.food-cheap:hover {
            background: var(--food-cheap);
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
        }

        #nav button.food-mid.active, #nav button.food-mid:hover {
            background: var(--food-mid);
            color: var(--text-color);
            box-shadow: 0 4px 15px rgba(253, 203, 110, 0.4);
        }

        #nav button.attractions.active, #nav button.attractions:hover {
            background: var(--attractions);
            box-shadow: 0 4px 15px rgba(225, 112, 85, 0.4);
        }

        #search-container {
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        #search-bar {
            width: 100%;
            padding: 12px 18px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            outline: none;
            transition: border-color 0.3s ease;
        }

        #search-bar:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #list-container {
            overflow-y: auto;
            flex-grow: 1;
            background: rgba(255,255,255,0.9);
        }

        #list-container ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #list-container li {
            padding: 18px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        #list-container li:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            transform: translateX(5px);
        }

        #list-container li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: transparent;
            transition: all 0.3s ease;
        }

        #list-container li.food-cheap::before { background: var(--food-cheap); }
        #list-container li.food-mid::before { background: var(--food-mid); }
        #list-container li.attractions::before { background: var(--attractions); }

        .item-name {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 4px;
        }
        
        .item-details {
            font-size: 0.85em;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            color: white;
        }

        .category-badge.food-cheap { background: var(--food-cheap); }
        .category-badge.food-mid { background: var(--food-mid); color: var(--text-color); }
        .category-badge.attractions { background: var(--attractions); }

        #details-panel {
            padding: 20px;
            background: rgba(255,255,255,0.95);
            border-top: 1px solid rgba(0,0,0,0.1);
            flex-shrink: 0;
            max-height: 40%;
            overflow-y: auto;
        }

        #details-panel h2 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.3em;
        }
        
        #details-panel .category {
            font-weight: 700;
            color: var(--accent-color);
            text-transform: uppercase;
            font-size: 0.8em;
            margin-bottom: 10px;
        }

        #details-panel p {
            line-height: 1.6;
            color: #555;
        }

        #map-container {
            flex-grow: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }

        .stats-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1000;
            display: flex;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            display: block;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
        }

        /* Custom Leaflet Popup Styles */
        .leaflet-popup-content-wrapper {
            background: var(--primary-color);
            color: var(--light-text-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .leaflet-popup-content {
            font-size: 1em;
            font-weight: 600;
            text-align: center;
            font-family: 'Poppins', sans-serif;
        }
        
        .leaflet-popup-tip {
            background: var(--primary-color);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #app-container {
                flex-direction: column;
            }
            #sidebar {
                width: 100%;
                height: 45vh;
                max-height: 45vh;
            }
            #sidebar-header h1 {
                font-size: 1.5em;
            }
            #nav {
                padding: 10px 5px;
            }
            #nav button {
                padding: 10px 12px;
                font-size: 0.8em;
                min-height: 44px; /* iOS touch target */
            }
            #search-bar {
                font-size: 16px; /* Previene zoom su iOS */
                min-height: 44px;
            }
            #list-container {
                max-height: calc(45vh - 200px);
            }
            #list-container li {
                padding: 20px 15px; /* Pi√π spazio per touch */
                min-height: 60px;
            }
            #details-panel {
                max-height: 25vh;
                padding: 15px;
            }
            #map-container {
                height: 55vh;
                min-height: 55vh;
            }
            .stats-overlay {
                position: absolute;
                bottom: 10px;
                left: 10px;
                right: 10px;
                top: auto;
                justify-content: space-around;
                background: rgba(255,255,255,0.9);
                backdrop-filter: blur(10px);
            }
            .stat-item {
                flex: 1;
            }
            .stat-number {
                font-size: 1.2em;
            }
            .stat-label {
                font-size: 0.7em;
            }
        }

        @media (max-width: 480px) {
            #sidebar-header {
                padding: 15px;
            }
            #nav {
                flex-wrap: wrap;
                gap: 5px;
            }
            #nav button {
                flex: 1;
                min-width: calc(50% - 5px);
                font-size: 0.75em;
            }
            .stats-overlay {
                padding: 10px;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            #list-container li:hover {
                background: rgba(102, 126, 234, 0.1);
                transform: none;
            }
            
            #nav button:hover {
                transform: none;
            }
            
            /* Larger touch targets for mobile */
            .custom-marker div {
                width: 24px !important;
                height: 24px !important;
                border: 4px solid white !important;
            }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            body {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
            }
            
            #map {
                -webkit-touch-callout: none;
            }
            
            input, button {
                -webkit-appearance: none;
                border-radius: 0;
            }
            
            #search-bar {
                border-radius: 25px;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <aside id="sidebar">
            <header id="sidebar-header">
                <h1>üó∫Ô∏è Mappa di Berlino</h1>
                <p>La tua guida interattiva completa</p>
            </header>
            <nav id="nav">
                <button id="btn-all" class="all active">üåü Tutto</button>
                <button id="btn-food-cheap" class="food-cheap">üçî Ristoranti ‚Ç¨</button>
                <button id="btn-food-mid" class="food-mid">üçΩÔ∏è Ristoranti ‚Ç¨‚Ç¨</button>
                <button id="btn-attractions" class="attractions">üèõÔ∏è Attrazioni</button>
            </nav>
            <div id="search-container">
                <input type="text" id="search-bar" placeholder="üîç Cerca un posto specifico...">
            </div>
            <div id="list-container">
                <!-- I contenuti verranno inseriti qui da JS -->
            </div>
            <div id="details-panel">
                <h2>Benvenuti a Berlino!</h2>
                <p>Seleziona una categoria e clicca su un punto di interesse per visualizzarne i dettagli e la posizione sulla mappa.</p>
            </div>
        </aside>
        <main id="map-container">
            <div id="map"></div>
            <div class="stats-overlay">
                <div class="stat-item">
                    <span class="stat-number" id="totalPoints">0</span>
                    <span class="stat-label">Luoghi totali</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="foodPoints">0</span>
                    <span class="stat-label">Ristoranti</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="attractionPoints">0</span>
                    <span class="stat-label">Attrazioni</span>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Aspetta che Leaflet sia caricato
        function waitForLeaflet() {
            if (typeof L !== 'undefined') {
                initializeApp();
            } else {
                setTimeout(waitForLeaflet, 100);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForLeaflet);
        } else {
            waitForLeaflet();
        }

        function initializeApp() {
            // Tutti i dati dai documenti originali con coordinate di Berlino
            const data = {
                "food-cheap": [
                    { name: "Berlin Burger International", category: "food-cheap", district: "Kreuzberg", lat: 52.4994, lon: 13.4183, description: "Il re degli hamburger berlinesi con hamburger grandi come due pugni" },
                    { name: "Bier's Kudamm 195", category: "food-cheap", district: "Charlottenburg", lat: 52.5048, lon: 13.3386, description: "Elegante chiosco con ottimo Currywurst e champagne" },
                    { name: "Curry 36", category: "food-cheap", district: "Kreuzberg", lat: 52.4985, lon: 13.4203, description: "L'istituzione per eccellenza della Currywurst berlinese" },
                    { name: "District M√¥t", category: "food-cheap", district: "Mitte", lat: 52.5208, lon: 13.4042, description: "Street food vietnamita che ricrea l'atmosfera di Saigon" },
                    { name: "Konnopke's Imbiss", category: "food-cheap", district: "Prenzlauer Berg", lat: 52.5322, lon: 13.4105, description: "Chiosco storico dal 1930 sotto i binari della U-Bahn" },
                    { name: "W -- der Imbiss", category: "food-cheap", district: "Prenzlauer Berg", lat: 52.5340, lon: 13.4120, description: "Mix perfetto di cucina italo-indiana con pizze naan" },
                    { name: "ALI BABA", category: "food-cheap", district: "Charlottenburg", lat: 52.5055, lon: 13.3370, description: "Pizza dalla crosta sottile e generose porzioni di pasta" },
                    { name: "Burgermeister", category: "food-cheap", district: "Kreuzberg", lat: 52.4988, lon: 13.4194, description: "Famoso chiosco in ex toilette pubblica sotto la U-Bahn" },
                    { name: "COCOLO RAMENBAR", category: "food-cheap", district: "Kreuzberg", lat: 52.4991, lon: 13.4178, description: "Considerato il miglior noodle bar della citt√†" },
                    { name: "DOLORES", category: "food-cheap", district: "Mitte", lat: 52.5175, lon: 13.3888, description: "Punto di riferimento per burritos in stile californiano" },
                    { name: "HAMY CAFE", category: "food-cheap", district: "Neuk√∂lln", lat: 52.4823, lon: 13.4347, description: "Istituzione per un pasto vietnamita veloce ed economico" },
                    { name: "MAROUSH", category: "food-cheap", district: "Kreuzberg", lat: 52.4996, lon: 13.4185, description: "Fantastici falafel e shawarma con succhi freschi" },
                    { name: "MASANIELLO", category: "food-cheap", district: "Neuk√∂lln", lat: 52.4835, lon: 13.4356, description: "Pizzeria napoletana con forno a legna e pizze giganti" },
                    { name: "SEEROSE", category: "food-cheap", district: "Kreuzberg", lat: 52.4989, lon: 13.4181, description: "Pioniere della cucina vegetariana a Berlino" },
                    { name: "STEELSHARK", category: "food-cheap", district: "Mitte", lat: 52.5168, lon: 13.4077, description: "Sushi di alta qualit√† nel Nikolaiviertel" }
                ],
                "food-mid": [
                    { name: "Bar Raval", category: "food-mid", district: "Kreuzberg", lat: 52.4997, lon: 13.4187, description: "Tapas bar di propriet√† dell'attore Daniel Br√ºhl" },
                    { name: "Cafe Jacques", category: "food-mid", district: "Kreuzberg", lat: 52.4993, lon: 13.4175, description: "Menu francese e nord-africano a lume di candela" },
                    { name: "Der Hahn ist tot!", category: "food-mid", district: "Prenzlauer Berg", lat: 52.5338, lon: 13.4115, description: "Ristorante francese famoso per il coq au vin" },
                    { name: "Henne", category: "food-mid", district: "Kreuzberg", lat: 52.4934, lon: 13.4078, description: "Locale storico dal 1907, famoso per il pollo arrosto" },
                    { name: "Ishin -- Mittelstrasse", category: "food-mid", district: "Mitte", lat: 52.5182, lon: 13.3885, description: "Sushi favoloso a prezzo irrisorio" },
                    { name: "Lisboa Bar", category: "food-mid", district: "Friedrichshain", lat: 52.5125, lon: 13.4532, description: "Avamposto portoghese con tapas sostanziose" },
                    { name: "Schneeweiss", category: "food-mid", district: "Friedrichshain", lat: 52.5130, lon: 13.4540, description: "Cucina alpina moderna in ambiente elegante" },
                    { name: "Umami", category: "food-mid", district: "Prenzlauer Berg", lat: 52.5335, lon: 13.4112, description: "Cucina indocinese creativa in atmosfera da salotto asiatico" },
                    { name: "Augustiner am Gendarmenmarkt", category: "food-mid", district: "Mitte", lat: 52.5137, lon: 13.3928, description: "Birreria bavarese nel cuore di Berlino" },
                    { name: "Gugelhof", category: "food-mid", district: "Prenzlauer Berg", lat: 52.5342, lon: 13.4118, description: "Perla della cucina regionale francese" },
                    { name: "HORV√ÅTH", category: "food-mid", district: "Kreuzberg", lat: 52.5001, lon: 13.4192, description: "Ristorante stellato che reinventa la cucina austriaca" },
                    { name: "MAX UND MORITZ", category: "food-mid", district: "Kreuzberg", lat: 52.4986, lon: 13.4169, description: "Trattoria-birrificio vecchio stile dal 1902" }
                ],
                "attractions": [
                    { name: "Brandenburger Tor", category: "attractions", district: "Mitte", lat: 52.5163, lon: 13.3777, description: "Simbolo iconico di Berlino e della riunificazione tedesca" },
                    { name: "Museumsinsel", category: "attractions", district: "Mitte", lat: 52.5204, lon: 13.3970, description: "Isola dei musei con 5 musei di fama mondiale, patrimonio UNESCO" },
                    { name: "East Side Gallery", category: "attractions", district: "Friedrichshain", lat: 52.5050, lon: 13.4394, description: "La pi√π grande galleria d'arte a cielo aperto del mondo" },
                    { name: "Checkpoint Charlie", category: "attractions", district: "Mitte", lat: 52.5075, lon: 13.3903, description: "Il pi√π celebre punto di passaggio della Guerra Fredda" },
                    { name: "Berliner Dom", category: "attractions", district: "Mitte", lat: 52.5191, lon: 13.4009, description: "Imponente chiesa neorinascimentale con cupola panoramica" },
                    { name: "Holocaust Mahnmal", category: "attractions", district: "Mitte", lat: 52.5138, lon: 13.3787, description: "Memoriale dell'Olocausto con 2711 stele di cemento" },
                    { name: "Fernsehturm", category: "attractions", district: "Mitte", lat: 52.5208, lon: 13.4094, description: "Torre della TV alta 368m, simbolo di Berlino" },
                    { name: "Schloss Charlottenburg", category: "attractions", district: "Charlottenburg", lat: 52.5209, lon: 13.2956, description: "La pi√π grande residenza reale di Berlino" },
                    { name: "Topographie des Terrors", category: "attractions", district: "Mitte", lat: 52.5065, lon: 13.3835, description: "Museo sul sito dell'ex quartier generale della Gestapo" },
                    { name: "Deutsches Historisches Museum", category: "attractions", district: "Mitte", lat: 52.5179, lon: 13.3969, description: "2000 anni di storia tedesca nell'ex arsenale" },
                    { name: "Gedenkst√§tte Berliner Mauer", category: "attractions", district: "Mitte", lat: 52.5354, lon: 13.3901, description: "Memoriale centrale della divisione tedesca" },
                    { name: "J√ºdisches Museum", category: "attractions", district: "Kreuzberg", lat: 52.5025, lon: 13.3948, description: "Museo della storia ebraica in edificio di Libeskind" },
                    { name: "DDR Museum", category: "attractions", district: "Mitte", lat: 52.5191, lon: 13.4018, description: "Museo interattivo sulla vita nella Germania Est" },
                    { name: "Potsdamer Platz", category: "attractions", district: "Mitte", lat: 52.5096, lon: 13.3758, description: "Quartiere rinato con architettura avveniristica" },
                    { name: "Reichstag", category: "attractions", district: "Mitte", lat: 52.5186, lon: 13.3762, description: "Parlamento tedesco con cupola di vetro di Norman Foster" },
                    { name: "Hackescher Markt", category: "attractions", district: "Mitte", lat: 52.5225, lon: 13.4016, description: "Quartiere boh√©mien con cortili d'arte e vita notturna" },
                    { name: "Mauerpark", category: "attractions", district: "Prenzlauer Berg", lat: 52.5407, lon: 13.4026, description: "Parco sulla ex striscia della morte con karaoke domenicale" },
                    { name: "Olympiastadion", category: "attractions", district: "Charlottenburg", lat: 52.5147, lon: 13.2395, description: "Stadio delle Olimpiadi del 1936, modernizzato nel 2006" },
                    { name: "Kaiser-Wilhelm-Ged√§chtniskirche", category: "attractions", district: "Charlottenburg", lat: 52.5049, lon: 13.3350, description: "Chiesa bombardata, simbolo contro la guerra" },
                    { name: "Tiergarten", category: "attractions", district: "Mitte", lat: 52.5145, lon: 13.3501, description: "Vasto parco urbano nel cuore di Berlino" },
                    { name: "Gendarmenmarkt", category: "attractions", district: "Mitte", lat: 52.5137, lon: 13.3928, description: "Una delle piazze pi√π belle d'Europa" },
                    { name: "Alexanderplatz", category: "attractions", district: "Mitte", lat: 52.5219, lon: 13.4132, description: "Piazza centrale con Fernsehturm e Weltzeituhr" },
                    { name: "Spandau Zitadelle", category: "attractions", district: "Spandau", lat: 52.5441, lon: 13.2123, description: "Fortezza rinascimentale meglio conservata d'Europa" },
                    { name: "Botanischer Garten", category: "attractions", district: "Dahlem", lat: 52.4576, lon: 13.3064, description: "22.000 specie vegetali e grande serra tropicale" }
                ]
            };

            // Inizializza la mappa Leaflet
            const map = L.map('map').setView([52.5200, 13.4050], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            const markers = {};
            let currentFilter = 'all';
            let searchTerm = '';

            const listContainer = document.getElementById('list-container');
            const detailsPanel = document.getElementById('details-panel');
            const searchBar = document.getElementById('search-bar');

            // Crea icone personalizzate per le categorie
            const createCustomIcon = (category) => {
                const colors = {
                    'food-cheap': '#00b894',
                    'food-mid': '#fdcb6e', 
                    'attractions': '#e17055'
                };
                
                // Marker pi√π grandi su mobile
                const isMobile = window.innerWidth <= 768;
                const size = isMobile ? 24 : 20;
                const borderSize = isMobile ? 4 : 3;
                
                return L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background-color: ${colors[category]};
                        width: ${size}px; 
                        height: ${size}px; 
                        border-radius: 50%; 
                        border: ${borderSize}px solid white;
                        box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                        cursor: pointer;
                    "></div>`,
                    iconSize: [size + borderSize * 2, size + borderSize * 2],
                    iconAnchor: [(size + borderSize * 2) / 2, (size + borderSize * 2) / 2]
                });
            };

            function showDetails(item) {
                const categoryNames = {
                    'food-cheap': 'Ristorante ‚Ç¨',
                    'food-mid': 'Ristorante ‚Ç¨‚Ç¨',
                    'attractions': 'Attrazione'
                };
                
                let detailsHTML = `
                    <h2>${item.name}</h2>
                    <p class="category">${categoryNames[item.category]} - ${item.district}</p>
                    <p>${item.description}</p>
                `;
                
                detailsPanel.innerHTML = detailsHTML;
                
                // Centra la mappa sul punto selezionato
                if (item.lat && item.lon) {
                    map.flyTo([item.lat, item.lon], 16);
                    const marker = markers[`${item.name}_${item.category}`];
                    if (marker) {
                        marker.openPopup();
                    }
                }
            }

            function populateList() {
                listContainer.innerHTML = '';
                const ul = document.createElement('ul');
                let itemsToShow = [];
                
                // Filtra i dati in base al filtro attivo
                if (currentFilter === 'all') {
                    itemsToShow = [...data['food-cheap'], ...data['food-mid'], ...data['attractions']];
                } else {
                    itemsToShow = data[currentFilter] || [];
                }
                
                // Applica filtro di ricerca
                if (searchTerm) {
                    itemsToShow = itemsToShow.filter(item => 
                        item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.district.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.description.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }

                itemsToShow.forEach(item => {
                    const li = document.createElement('li');
                    li.className = item.category;
                    
                    const categoryNames = {
                        'food-cheap': 'Ristorante ‚Ç¨',
                        'food-mid': 'Ristorante ‚Ç¨‚Ç¨',
                        'attractions': 'Attrazione'
                    };

                    li.innerHTML = `
                        <span class="item-name">${item.name}</span>
                        <span class="item-details">
                            <span class="category-badge ${item.category}">${categoryNames[item.category]}</span>
                            üìç ${item.district}
                        </span>
                    `;
                    
                    li.addEventListener('click', () => showDetails(item));
                    ul.appendChild(li);
                });
                
                listContainer.appendChild(ul);
                updateStats();
            }

            function updateMarkers() {
                // Rimuovi tutti i marker esistenti
                Object.values(markers).forEach(marker => map.removeLayer(marker));
                Object.keys(markers).forEach(key => delete markers[key]);
                
                // Aggiungi i marker filtrati
                let itemsToShow = [];
                if (currentFilter === 'all') {
                    itemsToShow = [...data['food-cheap'], ...data['food-mid'], ...data['attractions']];
                } else {
                    itemsToShow = data[currentFilter] || [];
                }
                
                // Applica filtro di ricerca
                if (searchTerm) {
                    itemsToShow = itemsToShow.filter(item => 
                        item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.district.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.description.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }
                
                itemsToShow.forEach(item => {
                    if (item.lat && item.lon) {
                        const marker = L.marker([item.lat, item.lon], {
                            icon: createCustomIcon(item.category)
                        }).addTo(map);
                        
                        marker.bindPopup(`<b>${item.name}</b><br>${item.district}`);
                        marker.on('click', () => showDetails(item));
                        markers[`${item.name}_${item.category}`] = marker;
                    }
                });
            }

            function updateStats() {
                let itemsToShow = [];
                if (currentFilter === 'all') {
                    itemsToShow = [...data['food-cheap'], ...data['food-mid'], ...data['attractions']];
                } else {
                    itemsToShow = data[currentFilter] || [];
                }
                
                if (searchTerm) {
                    itemsToShow = itemsToShow.filter(item => 
                        item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.district.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.description.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }
                
                const foodItems = itemsToShow.filter(item => 
                    item.category === 'food-cheap' || item.category === 'food-mid'
                );
                const attractionItems = itemsToShow.filter(item => item.category === 'attractions');
                
                document.getElementById('totalPoints').textContent = itemsToShow.length;
                document.getElementById('foodPoints').textContent = foodItems.length;
                document.getElementById('attractionPoints').textContent = attractionItems.length;
            }

            // Event listeners
            document.querySelectorAll('#nav button').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('#nav button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilter = e.target.id.replace('btn-', '');
                    populateList();
                    updateMarkers();
                });
            });

            searchBar.addEventListener('input', (e) => {
                searchTerm = e.target.value;
                populateList();
                updateMarkers();
            });

            // Gestione cambio orientamento mobile
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    map.invalidateSize();
                    updateMarkers(); // Ridimensiona marker per nuovo layout
                }, 500);
            });

            // Gestione resize finestra
            window.addEventListener('resize', () => {
                map.invalidateSize();
                updateMarkers();
            });

            // Inizializzazione
            populateList();
            updateMarkers();
        }
    </script>
</body>
</html>