<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Guida Completa di Berlino - 4 Giorni</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó∫Ô∏è</text></svg>">
    
    <!-- LeafletJS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #FF6B6B;
            --food-budget: #00b894;
            --food-mid: #fdcb6e;
            --food-luxury: #e84393;
            --attractions: #e17055;
            --itinerary: #6c5ce7;
            --text-color: #333;
            --light-text-color: #fff;
            --border-radius: 12px;
            --box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-color);
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        #app-container {
            display: flex;
            height: 100vh;
        }

#sidebar {
    width: 450px;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    box-shadow: 2px 0 20px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease-in-out;
    position: relative;
    z-index: 1000;
}

/* AGGIUNGERE STATO COLLASSATO */
#sidebar.collapsed {
    transform: translateX(-100%);
}

        #sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--light-text-color);
            text-align: center;
        }

        #sidebar-header h1 {
            margin: 0;
            font-size: 1.6em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        #sidebar-header p {
            margin: 8px 0 0;
            font-weight: 300;
            opacity: 0.9;
            font-size: 0.9em;
        }

        #main-nav {
            display: flex;
            background: rgba(255,255,255,0.9);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        #main-nav button {
            flex: 1;
            background: none;
            border: none;
            padding: 15px 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6c757d;
            position: relative;
        }

        #main-nav button.active {
            color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        #filter-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        #filter-nav button {
            background: none;
            border: none;
            padding: 8px 12px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6c757d;
            border-radius: 20px;
            position: relative;
            white-space: nowrap;
        }

        #filter-nav button.active, #filter-nav button:hover {
            color: var(--light-text-color);
            transform: translateY(-1px);
        }

        #filter-nav button.all.active, #filter-nav button.all:hover {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        #filter-nav button.active {
            position: relative;
        }

        #filter-nav button.active:after {
            content: '‚úì';
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        #filter-nav button.all.active:after {
            display: none;
        }

        #filter-nav button.food-budget.active, #filter-nav button.food-budget:hover {
            background: var(--food-budget);
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
        }

        #filter-nav button.food-mid.active, #filter-nav button.food-mid:hover {
            background: var(--food-mid);
            color: var(--text-color);
            box-shadow: 0 4px 15px rgba(253, 203, 110, 0.4);
        }

        #filter-nav button.food-luxury.active, #filter-nav button.food-luxury:hover {
            background: var(--food-luxury);
            box-shadow: 0 4px 15px rgba(232, 67, 147, 0.4);
        }

        #filter-nav button.attractions.active, #filter-nav button.attractions:hover {
            background: var(--attractions);
            box-shadow: 0 4px 15px rgba(225, 112, 85, 0.4);
        }

        #filter-nav button.itinerary.active, #filter-nav button.itinerary:hover {
            background: var(--itinerary);
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
        }

        #search-container {
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        #search-bar {
            width: 100%;
            padding: 12px 18px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            outline: none;
            transition: border-color 0.3s ease;
        }

        #search-bar:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #list-container {
            overflow-y: auto;
            flex-grow: 1;
            background: rgba(255,255,255,0.9);
        }

        #list-container ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #list-container li {
            padding: 18px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        #list-container li:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            transform: translateX(5px);
        }

        #list-container li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: transparent;
            transition: all 0.3s ease;
        }

        #list-container li.district-item {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            border-radius: 8px;
            margin: 8px 0;
        }

        #list-container li.district-item:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            transform: translateX(8px);
        }

        #list-container li.itinerary-item {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.03), rgba(118, 75, 162, 0.03));
            border-radius: 8px;
            margin: 8px 0;
            padding: 20px;
        }

        #list-container li.itinerary-item:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
            transform: translateX(3px);
        }

        .itinerary-number {
            pointer-events: none;
        }

        #list-container li.food-budget::before { background: var(--food-budget); }
        #list-container li.food-mid::before { background: var(--food-mid); }
        #list-container li.food-luxury::before { background: var(--food-luxury); }
        #list-container li.attractions::before { background: var(--attractions); }
        #list-container li.itinerary::before { background: var(--itinerary); }

        .item-name {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 4px;
        }
        
        .item-details {
            font-size: 0.85em;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .item-description {
            font-size: 0.8em;
            color: #777;
            margin-top: 6px;
            line-height: 1.4;
        }

        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            color: white;
        }

        .category-badge.food-budget { background: var(--food-budget); }
        .category-badge.food-mid { background: var(--food-mid); color: var(--text-color); }
        .category-badge.food-luxury { background: var(--food-luxury); }
        .category-badge.attractions { background: var(--attractions); }
        .category-badge.itinerary { background: var(--itinerary); }

        .ranking-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.65em;
            font-weight: bold;
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .ranking-badge.top { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .ranking-badge.good { background: #fff3cd; color: #856404; border-color: #ffeaa7; }

        #details-panel {
            padding: 20px;
            background: rgba(255,255,255,0.95);
            border-top: 1px solid rgba(0,0,0,0.1);
            flex-shrink: 0;
            max-height: 40%;
            overflow-y: auto;
        }

        #details-panel h2 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.3em;
        }
        
        #details-panel .category {
            font-weight: 700;
            color: var(--accent-color);
            text-transform: uppercase;
            font-size: 0.8em;
            margin-bottom: 10px;
        }

        #details-panel p {
            line-height: 1.6;
            color: #555;
            margin-bottom: 10px;
        }

        #details-panel .specialty {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            margin: 10px 0;
        }

        #details-panel .specialty strong {
            color: var(--primary-color);
        }

        #map-container {
            flex-grow: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }

       

        .active-filters-indicator {
            position: absolute;
            bottom: 85px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            border-radius: 20px;
            box-shadow: var(--box-shadow);
            z-index: 1000;
            font-size: 0.8em;
            color: var(--primary-color);
            font-weight: 600;
            display: none;
        }

        .active-filters-indicator.show {
            display: block;
        }

        .itinerary-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 450px;
            max-height: 60vh;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(15px);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1000;
            display: none;
            overflow-y: auto;
            border-top: 4px solid var(--itinerary);
            transition: all 0.3s ease-in-out;
        }

        .itinerary-info.active {
            display: block;
        }

        .itinerary-info.collapsed {
            max-height: 80px;
            overflow: hidden;
            cursor: pointer;
        }

        .itinerary-info.collapsed:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-2px);
        }

        .itinerary-info-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            position: relative;
        }

        .itinerary-info h3 {
            margin: 0;
            color: var(--itinerary);
            font-size: 1.2em;
            line-height: 1.3;
            flex-grow: 1;
            padding-right: 10px;
        }

        .itinerary-toggle-btn {
            background: var(--itinerary);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(108, 92, 231, 0.3);
        }

        .itinerary-toggle-btn:hover {
            background: var(--primary-color);
            transform: scale(1.1);
        }

        .itinerary-content {
            transition: opacity 0.3s ease;
        }

        .itinerary-info.collapsed .itinerary-content {
            opacity: 0;
        }

        .collapse-hint {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .itinerary-info.collapsed .collapse-hint {
            opacity: 1;
        }

        .itinerary-info p {
            margin: 0;
            font-size: 0.9em;
            color: #555;
            line-height: 1.5;
        }

        .itinerary-info h4 {
            color: var(--itinerary);
            font-size: 1em;
            margin: 20px 0 10px 0;
            border-bottom: 1px solid rgba(108, 92, 231, 0.3);
            padding-bottom: 5px;
        }

        .itinerary-section {
            margin: 12px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .itinerary-section:last-child {
            border-bottom: none;
        }

        .tip {
            background: linear-gradient(90deg, rgba(108, 92, 231, 0.1), rgba(102, 126, 234, 0.1));
            padding: 10px;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 3px solid var(--itinerary);
            font-size: 0.85em;
        }

        .itinerary-info::-webkit-scrollbar {
            width: 6px;
        }

        .itinerary-info::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
        }

        .itinerary-info::-webkit-scrollbar-thumb {
            background: var(--itinerary);
            border-radius: 3px;
        }

        .itinerary-info::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        /* Stile personalizzato per il controllo layer */
        .leaflet-control-layers {
            background: rgba(255,255,255,0.95) !important;
            backdrop-filter: blur(10px);
            border-radius: 12px !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
            border: none !important;
            padding: 10px !important;
            font-family: 'Poppins', sans-serif !important;
        }
.leaflet-control-layers.leaflet-control-layers-expanded {
    background: rgba(255,255,255,0.98) !important;
    backdrop-filter: blur(15px) !important;
    border-radius: 12px !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
    border: 1px solid rgba(255,255,255,0.2) !important;
    padding: 15px !important;
    min-width: 220px !important;
    transition: all 0.3s ease !important;
}

.leaflet-control-layers:not(.leaflet-control-layers-expanded) {
    padding: 2px !important;
    width: 32px !important;
    height: 32px !important;
    min-width: 32px !important;
    min-height: 32px !important;
    transition: all 0.3s ease !important;
}

.leaflet-control-layers-toggle {
    background: rgba(255,255,255,0.95) !important;
    backdrop-filter: blur(10px) !important;
    border-radius: 8px !important;
    padding: 8px !important;
    transition: all 0.2s ease !important;
}

.leaflet-control-layers-toggle:hover {
    background: var(--primary-color) !important;
    transform: scale(1.05) !important;
}

.leaflet-control-layers-toggle:after {
    content: 'üéõÔ∏è' !important;
    font-size: 16px !important;
}

.leaflet-control-layers.leaflet-control-layers-expanded .leaflet-control-layers-toggle:after {
    content: 'üìä' !important;
}
        .leaflet-control-layers-toggle {
            background-image: none !important;
            width: auto !important;
            height: auto !important;
        }

        .leaflet-control-layers-toggle:after {
    content: 'üèòÔ∏è';
    font-size: 14px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
}

        .leaflet-control-layers label {
            font-family: 'Poppins', sans-serif !important;
            font-size: 0.9em !important;
            font-weight: 600 !important;
            color: var(--text-color) !important;
            margin-left: 8px !important;
        }

        .leaflet-control-layers input[type="checkbox"] {
            margin-right: 8px !important;
        }

        /* Custom Leaflet Popup Styles */
        .leaflet-popup-content-wrapper {
            background: var(--primary-color);
            color: var(--light-text-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .leaflet-popup-content {
            font-size: 1em;
            font-weight: 600;
            text-align: center;
            font-family: 'Poppins', sans-serif;
        }
        
        .leaflet-popup-tip {
            background: var(--primary-color);
        }

        /* Mobile Responsive */
       @media (max-width: 768px) {
    /* Mostra il pulsante toggle su mobile */
    .sidebar-toggle-btn {
        display: flex !important;
    }
    
    #app-container {
        flex-direction: row;
        position: relative;
    }
    
    #sidebar {
        position: absolute;
        top: 0;
        left: 0;
        width: 350px;
        height: 100vh;
        max-height: 100vh;
        z-index: 1000;
        transform: translateX(-100%);
    }
    
    #sidebar.show {
        transform: translateX(0);
    }
    
    #map-container {
        width: 100%;
        height: 100vh;
        min-height: 100vh;
    }

    /* Resto degli stili mobile esistenti */
    #sidebar-header h1 {
        font-size: 1.4em;
    }
    #main-nav button {
        padding: 12px 8px;
        font-size: 0.8em;
    }
    #filter-nav {
        padding: 10px;
        gap: 5px;
    }
    #filter-nav button {
        padding: 6px 10px;
        font-size: 0.7em;
    }
    #search-bar {
        font-size: 16px;
        min-height: 44px;
    }
    #list-container {
        max-height: calc(100vh - 220px);
    }
    #list-container li {
        padding: 16px 15px;
        min-height: 60px;
    }
    #details-panel {
        max-height: 25vh;
        padding: 15px;
    }
    
    .itinerary-info {
        bottom: 10px;
        left: 10px;
        right: 10px;
        width: auto;
        max-height: 40vh;
        padding: 15px;
    }
    
    .itinerary-info.collapsed {
        max-height: 70px;
    }
    
    .itinerary-info h3 {
        font-size: 1em;
        margin-bottom: 10px;
    }
    
    .itinerary-toggle-btn {
        width: 28px;
        height: 28px;
        font-size: 14px;
    }
    
    .itinerary-info h4 {
        font-size: 0.9em;
        margin: 15px 0 8px 0;
    }
    
    .tip {
        padding: 8px;
        font-size: 0.8em;
    }

    .location-control {
    top: 20px;
    bottom: auto;
    left: auto;
    right: 80px;
    width: 45px;
    height: 45px;
    font-size: 18px;
}

    .leaflet-control-layers {
        min-width: 180px !important;
        padding: 10px !important;
    }
    
    .leaflet-control-layers label {
        font-size: 0.8em !important;
        margin-bottom: 6px !important;
    }
}
.location-control {
    position: absolute;
    top: 140px;
    left: 20px;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    padding: 10px;
    border-radius: 50%;
    box-shadow: var(--box-shadow);
    z-index: 1000;
    cursor: pointer;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: all 0.3s ease;
}

.location-control:hover {
    background: var(--primary-color);
    color: white;
    transform: scale(1.1);
}

.location-control.active {
    background: var(--accent-color);
    color: white;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
}

/* Responsive mobile */
@media (max-width: 768px) {
    .location-control {
       top: 20px;
        bottom: auto;
        left: 80px;
        width: 45px;
        height: 45px;
        font-size: 18px;
    }
}
/* Stili per il controllo layer migliorato */
.leaflet-control-layers {
    background: rgba(255,255,255,0.98) !important;
    backdrop-filter: blur(15px) !important;
    border-radius: 12px !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
    border: 1px solid rgba(255,255,255,0.2) !important;
    padding: 12px !important;
    font-family: 'Poppins', sans-serif !important;
    min-width: 200px !important;
}

.leaflet-control-layers-toggle {
    background-image: none !important;
    width: auto !important;
    height: auto !important;
    padding: 8px !important;
}

.leaflet-control-layers-toggle:after {
    content: '';
    font-size: 18px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.leaflet-control-layers label {
    font-family: 'Poppins', sans-serif !important;
    font-size: 0.9em !important;
    font-weight: 600 !important;
    color: var(--text-color) !important;
    margin-left: 10px !important;
    margin-bottom: 8px !important;
    display: flex !important;
    align-items: center !important;
    cursor: pointer !important;
    transition: color 0.2s ease !important;
}

.leaflet-control-layers label:hover {
    color: var(--primary-color) !important;
}

.leaflet-control-layers input[type="checkbox"] {
    margin-right: 10px !important;
    width: 16px !important;
    height: 16px !important;
    cursor: pointer !important;
}

/* Stile per quando la mappa base √® nascosta */
.leaflet-container.no-base-map {
    background-color: #f8f9fa !important;
}
/* Sfondo ottimizzato per solo fermate */
.leaflet-container.stations-only {
    background-color: #f8f9fa !important; /* Grigio chiaro per distinguere le fermate */
}

/* Stili per icone fermate */
.transit-station-icon {
    cursor: pointer !important;
}

.transit-station-icon:hover div {
    transform: scale(1.1);
    transition: transform 0.2s ease;
}
/* Sfondo ottimizzato per solo trasporti */
.leaflet-container.transport-only {
    background-color: #ffffff !important; /* Bianco puro per massima leggibilit√† delle linee */
}

/* Sfondo normale quando c'√® la mappa base (con o senza trasporti) */
.leaflet-container:not(.no-base-map):not(.transport-only) {
    background-color: #ffffff !important;
}

/* Migliora la visibilit√† dei trasporti quando sovrapposti alla mappa */
.leaflet-container:not(.transport-only) .leaflet-overlay-pane img[src*="memomaps"] {
    opacity: 0.8 !important; /* Rendi i trasporti leggermente pi√π trasparenti sulla mappa */
    mix-blend-mode: multiply; /* Effetto di fusione per migliore integrazione */
}

/* Mantieni i trasporti completamente opachi in modalit√† solo-trasporti */
.leaflet-container.transport-only .leaflet-overlay-pane img[src*="memomaps"] {
    opacity: 1 !important;
    mix-blend-mode: normal;
}
/* Responsive mobile */
@media (max-width: 768px) {
    .leaflet-control-layers {
        min-width: 180px !important;
        padding: 10px !important;
    }
    
    .leaflet-control-layers label {
        font-size: 0.8em !important;
        margin-bottom: 6px !important;
    }
}
        .hidden {
            display: none !important;
        }

/* Animazione per l'hotel - SENZA TRANSFORM */
@keyframes hotel-pulse {
    0% { 
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        filter: brightness(1);
    }
    50% { 
        box-shadow: 0 8px 30px rgba(255, 107, 107, 1);
        filter: brightness(1.1);
    }
    100% { 
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        filter: brightness(1);
    }
}

@keyframes hotel-glow {
    0%, 100% { 
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.8);
        filter: brightness(1);
    }
    50% { 
        box-shadow: 0 12px 35px rgba(255, 107, 107, 1);
        filter: brightness(1.15);
    }
}

.hotel-marker {
    animation: hotel-pulse 3s infinite;
}

.hotel-marker-permanent {
    animation: hotel-glow 4s infinite;
}

.hotel-marker-special {
    animation: hotel-glow 4s infinite;
}
.sidebar-toggle-btn {
    position: absolute;
    top: 20px;
    left: 20px;
    width: 50px;
    height: 50px;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    border: none;
    border-radius: 50%;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    z-index: 2000;
    cursor: pointer;
    font-size: 20px;
    color: var(--primary-color);
    transition: all 0.3s ease;
    display: none;
    align-items: center;
    justify-content: center;
}

.sidebar-toggle-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: scale(1.1);
}

.sidebar-toggle-btn.active {
    background: var(--primary-color);
    color: white;
}

/* Stato collassato sidebar */
#sidebar.collapsed {
    transform: translateX(-100%);
}

#sidebar.show {
    transform: translateX(0);
}
    </style>
</head>
<body>

    <div id="app-container">
        <aside id="sidebar">
            <header id="sidebar-header">
                <h1>üó∫Ô∏è Guida Completa di Berlino</h1>
                <p>4 giorni tra storia, arte e sapori</p>
            </header>
            
            <nav id="main-nav">
                <button id="btn-places" class="active">üìç Luoghi</button>
                <button id="btn-itinerary">üìÖ Itinerario</button>
                <button id="btn-districts">üèòÔ∏è Quartieri</button>
            </nav>
            
            <div id="filter-nav">
                <button id="btn-all" class="all active">üåü Tutto</button>
                <button id="btn-food-budget" class="food-budget">ü•™ ‚Ç¨ Economici</button>
                <button id="btn-food-mid" class="food-mid">ü•™ ‚Ç¨‚Ç¨ Medi</button>
                <button id="btn-food-luxury" class="food-luxury">ü•™ ‚Ç¨‚Ç¨‚Ç¨ Lusso</button>
                <button id="btn-attractions" class="attractions">üèõÔ∏è Attrazioni</button>
                <button id="btn-day1" class="itinerary">üìÖ Giorno 1</button>
                <button id="btn-day2" class="itinerary">üìÖ Giorno 2</button>
                <button id="btn-day3" class="itinerary">üìÖ Giorno 3</button>
                <button id="btn-day4" class="itinerary">üìÖ Giorno 4</button>
            </div>
            
            <div id="search-container">
                <input type="text" id="search-bar" placeholder="üîç Cerca luoghi, ristoranti, attrazioni...">
            </div>
            
            <div id="list-container">
                <!-- I contenuti verranno inseriti qui da JS -->
            </div>
            
            <div id="details-panel">
                <h2>Benvenuti nella Guida Completa di Berlino!</h2>
                <p>Questa guida interattiva ti accompagner√† in un viaggio di 4 giorni attraverso la storia, l'arte e i sapori di Berlino.</p>
                <p><strong>Come usare la guida:</strong></p>
                <p>‚Ä¢ Naviga tra <strong>Luoghi</strong>, <strong>Itinerario</strong> e <strong>Quartieri</strong></p>
                <p>‚Ä¢ Filtra per categoria di prezzo o giorno dell'itinerario</p>
                <p>‚Ä¢ Clicca su un luogo per vedere dettagli e posizione sulla mappa</p>
            </div>
        </aside>
        
        <main id="map-container">
            <!-- AGGIUNGERE QUESTO ELEMENTO -->
<button id="sidebar-toggle" class="sidebar-toggle-btn" onclick="toggleSidebar()">
    ‚ò∞
</button>
            <div id="map"></div>
             <button id="sidebar-toggle" class="sidebar-toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
           
            <div class="location-control" id="location-btn" onclick="toggleLocation()" title="La mia posizione">
        üìç
    </div>
            <div class="active-filters-indicator" id="active-filters-indicator">
                Filtri attivi: Tutto
            </div>
            
            <div class="itinerary-info" id="itinerary-info">
                <div class="itinerary-info-header">
                    <h3 id="itinerary-title">Benvenuto negli Itinerari di Berlino</h3>
                    <button class="itinerary-toggle-btn" id="itinerary-toggle-btn" onclick="toggleItineraryInfo()">
                        ‚ñº
                    </button>
                </div>
                <div class="collapse-hint">Clicca qui o sul pulsante per espandere</div>
                <div class="itinerary-content" id="itinerary-description">
                    <p>Seleziona un giorno dall'itinerario per vedere il percorso dettagliato sulla mappa e tutte le informazioni per organizzare la tua giornata perfetta a Berlino.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Aspetta che Leaflet sia caricato
        function waitForLeaflet() {
            if (typeof L !== 'undefined') {
                initializeApp();
            } else {
                setTimeout(waitForLeaflet, 100);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForLeaflet);
        } else {
            waitForLeaflet();
        }

        function initializeApp() {
            // Dati completi dalla guida - VERSIONE COMPLETA E CORRETTA
            const data = {
                // HOTEL
                "hotel": [
                    { name: "Hotel Berlin, Berlin, a member of Radisson Individuals", category: "hotel", district: "Tiergarten", lat: 52.504226, lon: 13.351910, description: "Il vostro hotel a L√ºtzowplatz 17", specialty: "Base perfetta per esplorare Berlino", ranking: "hotel", day: null }
                ],

                // RISTORANTI ECONOMICI (‚Ç¨)
                "food-budget": [
                    { name: "Berlin Burger International", category: "food-budget", district: "Kreuzberg", lat: 52.4994, lon: 13.4183, description: "Il re degli hamburger berlinesi con hamburger grandi come due pugni", specialty: "Hamburger giganti", ranking: "top", day: 1 },
                    { name: "Curry 36", category: "food-budget", district: "Kreuzberg", lat: 52.4985, lon: 13.4203, description: "L'istituzione per eccellenza della Currywurst berlinese", specialty: "Currywurst", ranking: "top", day: 1 },
                    { name: "Konnopke's Imbiss", category: "food-budget", district: "Prenzlauer Berg", lat: 52.5322, lon: 13.4105, description: "Chiosco storico dal 1930 sotto i binari della U-Bahn", specialty: "Currywurst storica", ranking: "top", day: 2 },
                    { name: "Burgermeister", category: "food-budget", district: "Kreuzberg", lat: 52.4988, lon: 13.4194, description: "Famoso chiosco in ex toilette pubblica sotto la U-Bahn", specialty: "Hamburger leggendari", ranking: "top", day: 3 },
                    { name: "Mustafa's Gem√ºse Kebap", category: "food-budget", district: "Kreuzberg", lat: 52.4996, lon: 13.4190, description: "Il kebab pi√π famoso del mondo", specialty: "Gem√ºse Kebap", ranking: "top", day: 3 },
                    { name: "Dolores", category: "food-budget", district: "Mitte", lat: 52.5175, lon: 13.3888, description: "Punto di riferimento per burritos in stile californiano", specialty: "Burrito Calimex", ranking: "top", day: 1 },
                    { name: "District M√¥t", category: "food-budget", district: "Mitte", lat: 52.5208, lon: 13.4042, description: "Street food vietnamita che ricrea l'atmosfera di Saigon", specialty: "Piatti vietnamiti da strada", ranking: "good", day: 2 },
                    { name: "Monsieur Vuong", category: "food-budget", district: "Scheunenviertel", lat: 52.5225, lon: 13.4020, description: "Colorato, chiassoso e sempre affollato", specialty: "Zuppa di Pho", ranking: "top", day: 2 },
                    { name: "W -- der Imbiss", category: "food-budget", district: "Prenzlauer Berg", lat: 52.5340, lon: 13.4120, description: "Mix perfetto di cucina italo-indiana con pizze naan", specialty: "Pizza naan", ranking: "good", day: 2 },
                    { name: "Maroush", category: "food-budget", district: "Kreuzberg", lat: 52.4996, lon: 13.4185, description: "Fantastici falafel e shawarma con succhi freschi", specialty: "Falafel e shawarma", ranking: "good", day: 3 },
                    { name: "V√∂ner", category: "food-budget", district: "Friedrichshain", lat: 52.5125, lon: 13.4535, description: "Il primo d√∂ner vegano di Berlino", specialty: "V√∂ner vegano", ranking: "good", day: 3 },
                    { name: "Restaurant Wandel", category: "food-budget", district: "Alexanderplatz", lat: 52.5210, lon: 13.4135, description: "Sofisticata tavola calda con prezzi imbattibili", specialty: "Buffet di insalate", ranking: "top", day: 1 },
                    { name: "taz.Cafe", category: "food-budget", district: "Mitte", lat: 52.5180, lon: 13.3980, description: "La caffetteria del quotidiano di sinistra taz", specialty: "Piatti del giorno", ranking: "good", day: 1 }
                ],

                // RISTORANTI FASCIA MEDIA (‚Ç¨‚Ç¨)
                "food-mid": [
                    { name: "Bar Raval", category: "food-mid", district: "Kreuzberg", lat: 52.4997, lon: 13.4187, description: "Tapas bar di propriet√† dell'attore Daniel Br√ºhl", specialty: "Tapas spagnole", ranking: "top", day: 3 },
                    { name: "Cafe Jacques", category: "food-mid", district: "Kreuzberg", lat: 52.4993, lon: 13.4175, description: "Menu francese e nord-africano a lume di candela", specialty: "Cucina francese-nordafricana", ranking: "good", day: 3 },
                    { name: "Der Hahn ist tot!", category: "food-mid", district: "Prenzlauer Berg", lat: 52.5338, lon: 13.4115, description: "Ristorante francese famoso per il coq au vin", specialty: "Coq au vin", ranking: "top", day: 2 },
                    { name: "Henne", category: "food-mid", district: "Kreuzberg", lat: 52.4934, lon: 13.4078, description: "Locale storico dal 1907, famoso per il pollo arrosto", specialty: "Mezzo pollo arrosto", ranking: "top", day: 4 },
                    { name: "Ishin -- Mittelstrasse", category: "food-mid", district: "Mitte", lat: 52.5182, lon: 13.3885, description: "Sushi favoloso a prezzo irrisorio", specialty: "Vassoi di sushi", ranking: "top", day: 1 },
                    { name: "Lisboa Bar", category: "food-mid", district: "Friedrichshain", lat: 52.5125, lon: 13.4532, description: "Avamposto portoghese con tapas sostanziose", specialty: "Tapas portoghesi", ranking: "good", day: 3 },
                    { name: "Schneeweiss", category: "food-mid", district: "Friedrichshain", lat: 52.5130, lon: 13.4540, description: "Cucina alpina moderna in ambiente elegante", specialty: "Cucina alpina moderna", ranking: "top", day: 3 },
                    { name: "Umami", category: "food-mid", district: "Prenzlauer Berg", lat: 52.5335, lon: 13.4112, description: "Cucina indocinese creativa in atmosfera da salotto asiatico", specialty: "Cucina indocinese", ranking: "good", day: 2 },
                    { name: "Augustiner am Gendarmenmarkt", category: "food-mid", district: "Mitte", lat: 52.5135, lon: 13.3925, description: "Autentica birreria bavarese nella splendida Gendarmenmarkt", specialty: "Piatti di maiale e birra", ranking: "top", day: 1 },
                    { name: "Gugelhof", category: "food-mid", district: "Prenzlauer Berg", lat: 52.5342, lon: 13.4118, description: "Perla della cucina regionale francese", specialty: "Cucina francese regionale", ranking: "top", day: 2 },
                    { name: "Max und Moritz", category: "food-mid", district: "Kreuzberg", lat: 52.4986, lon: 13.4169, description: "Trattoria-birrificio vecchio stile dal 1902", specialty: "Cucina tradizionale tedesca", ranking: "good", day: 3 },
                    { name: "Katz Orange", category: "food-mid", district: "Scheunenviertel", lat: 52.5220, lon: 13.4015, description: "Atmosfera magica in un ex birrificio", specialty: "Carne a cottura lenta", ranking: "top", day: 2 },
                    { name: "Kopps", category: "food-mid", district: "Scheunenviertel", lat: 52.5230, lon: 13.4025, description: "Il pioniere della cucina vegana gourmet a Berlino", specialty: "Brunch vegano", ranking: "top", day: 2 },
                    { name: "Mogg & Melzer", category: "food-mid", district: "Scheunenviertel", lat: 52.5218, lon: 13.4018, description: "Deli in stile newyorkese", specialty: "Pastrami e matzo ball soup", ranking: "good", day: 2 },
                    { name: "Ch√®n Ch√®", category: "food-mid", district: "Scheunenviertel", lat: 52.5228, lon: 13.4022, description: "Sala da t√® vietnamita con giardino zen", specialty: "Pho e piatti tradizionali", ranking: "good", day: 2 },
                    { name: "Sp√§tzle & Kn√∂del", category: "food-mid", district: "Friedrichshain", lat: 52.5128, lon: 13.4538, description: "Gastropub specializzato in cucina tedesca del sud", specialty: "Sp√§tzle e Kn√∂del", ranking: "good", day: 3 },
                    { name: "Cocolo Ramenbar", category: "food-mid", district: "Kreuzberg", lat: 52.4991, lon: 13.4178, description: "Il miglior ramen bar della citt√†", specialty: "Zuppa di ramen", ranking: "top", day: 3 },
                    { name: "Zur Letzten Instanz", category: "food-mid", district: "Alexanderplatz", lat: 52.5185, lon: 13.4165, description: "Locale rustico del 1621, ha sfamato Napoleone e Angela Merkel", specialty: "Stinco di maiale al forno", ranking: "top", day: 1 },
                    { name: "Brauhaus Georgbr√§u", category: "food-mid", district: "Nikolaiviertel", lat: 52.5170, lon: 13.4070, description: "Birreria con Biergarten sulla Sprea", specialty: "Stinco di maiale lesso", ranking: "good", day: 1 },
                    { name: "Hofbr√§uhaus Berlin", category: "food-mid", district: "Alexanderplatz", lat: 52.5200, lon: 13.4130, description: "Atmosfera dell'Oktoberfest tutto l'anno", specialty: "Litri di birra e piatti bavaresi", ranking: "good", day: 1 },
                    { name: "Good Friends", category: "food-mid", district: "Charlottenburg", lat: 52.5055, lon: 13.3350, description: "Considerato il miglior ristorante cinese di Berlino", specialty: "Anatra alla pechinese", ranking: "top", day: 4 },
                    { name: "Rogacki", category: "food-mid", district: "Charlottenburg", lat: 52.5060, lon: 13.3360, description: "Gastronomia leggendaria fondata nel 1928", specialty: "Pesce affumicato", ranking: "top", day: 4 },
                    { name: "Dicke Wirtin", category: "food-mid", district: "Charlottenburg", lat: 52.5058, lon: 13.3365, description: "Pub vecchio stile, atmosfera immutata da decenni", specialty: "Piatti sostanziosi tedeschi", ranking: "good", day: 4 },
                    { name: "Weilands Wellfood", category: "food-mid", district: "Mitte", lat: 52.5092, lon: 13.3755, description: "Opzioni sane e veloci a Potsdamer Platz", specialty: "Piatti salutari", ranking: "good", day: 1 },
                    { name: "Berliner Republik", category: "food-mid", district: "Mitte", lat: 52.5195, lon: 13.3875, description: "Pub vivace sulla Sprea con vista fiume", specialty: "Birra e piatti tedeschi", ranking: "good", day: 2 },
                    { name: "Schwarzwaldstuben", category: "food-mid", district: "Scheunenviertel", lat: 52.5220, lon: 13.4010, description: "Cucina tedesca del sud in atmosfera accogliente", specialty: "Piatti della Foresta Nera", ranking: "good", day: 2 }
                ],

                // RISTORANTI DI LUSSO (‚Ç¨‚Ç¨‚Ç¨)
                "food-luxury": [
                    { name: "Horv√°th", category: "food-luxury", district: "Kreuzberg", lat: 52.5001, lon: 13.4192, description: "Ristorante stellato che reinventa la cucina austriaca", specialty: "Men√π degustazione austriaco", ranking: "top", day: 3 },
                    { name: "Restaurant Tim Raue", category: "food-luxury", district: "Mitte", lat: 52.5075, lon: 13.3900, description: "Due stelle Michelin, cucina asiatica creativa", specialty: "Men√π degustazione asiatico", ranking: "top", day: 1 },
                    { name: "Borchardt", category: "food-luxury", district: "Mitte", lat: 52.5140, lon: 13.3925, description: "Istituzione berlinese, ritrovo di celebrit√†", specialty: "Wiener Schnitzel", ranking: "top", day: 1 },
                    { name: "Grill Royal", category: "food-luxury", district: "Mitte", lat: 52.5195, lon: 13.3985, description: "Tempio della carne sulla Sprea, frequentato da VIP", specialty: "Bistecche e ostriche", ranking: "top", day: 1 },
                    { name: "Facil", category: "food-luxury", district: "Mitte", lat: 52.5145, lon: 13.3920, description: "Due stelle Michelin in cortile di vetro con bamb√π", specialty: "Cucina innovativa", ranking: "top", day: 1 },
                    { name: "Pauly Saal", category: "food-luxury", district: "Scheunenviertel", lat: 52.5215, lon: 13.4012, description: "Ristorante stellato nella ex scuola ebraica", specialty: "Cucina regionale tedesca", ranking: "top", day: 2 },
                    { name: "Volt", category: "food-luxury", district: "Kreuzberg", lat: 52.5000, lon: 13.4195, description: "Cucina tedesca moderna in ex sottostazione elettrica", specialty: "Men√π degustazione", ranking: "top", day: 4 },
                    { name: "La Raclette", category: "food-luxury", district: "Kreuzberg", lat: 52.4995, lon: 13.4180, description: "Piccolo ristorante francese accogliente", specialty: "Raclette filante", ranking: "good", day: 3 },
                    { name: "Brooklyn Beef Club", category: "food-luxury", district: "Alexanderplatz", lat: 52.5190, lon: 13.4140, description: "Elegante steakhouse con atmosfera da film noir", specialty: "Bistecche angus di qualit√†", ranking: "top", day: 1 },
                    { name: "Restaurant am Steinplatz", category: "food-luxury", district: "Charlottenburg", lat: 52.5065, lon: 13.3355, description: "Ristorante dell'Hotel am Steinplatz", specialty: "Cucina tedesca moderna", ranking: "good", day: 4 },
                    { name: "Dachgartenrestaurant K√§fer im Bundestag", category: "food-luxury", district: "Mitte", lat: 52.5186, lon: 13.3762, description: "L'unico ristorante al mondo in un parlamento", specialty: "Cucina tedesca moderna con vista", ranking: "top", day: 1 },
                    { name: "Desbrosses", category: "food-luxury", district: "Mitte", lat: 52.5088, lon: 13.3760, description: "Elegante brasserie francese all'interno del Ritz-Carlton", specialty: "Cucina francese raffinata", ranking: "top", day: 1 }
                ],

                // ATTRAZIONI COMPLETE
                "attractions": [
                    // Giorno 1 - I Grandi Simboli (MODIFICATO)
                    { name: "Reichstag", category: "attractions", district: "Mitte", lat: 52.5186, lon: 13.3762, description: "Parlamento tedesco con cupola di vetro di Norman Foster", specialty: "Cupola panoramica gratuita (prenotazione obbligatoria)", ranking: "top", day: 1 },
                    { name: "Porta di Brandeburgo", category: "attractions", district: "Mitte", lat: 52.5163, lon: 13.3777, description: "Simbolo iconico di Berlino e della riunificazione tedesca", specialty: "Il simbolo pi√π famoso della citt√†", ranking: "top", day: 1 },
                    { name: "Holocaust Mahnmal", category: "attractions", district: "Mitte", lat: 52.5138, lon: 13.3787, description: "Memoriale dell'Olocausto con 2711 stele di cemento", specialty: "Centro informazioni sotterraneo", ranking: "top", day: 1 },
                    { name: "Potsdamer Platz", category: "attractions", district: "Mitte", lat: 52.5096, lon: 13.3758, description: "Quartiere rinato con architettura avveniristica", specialty: "Sony Center con tetto illuminato", ranking: "top", day: 1 },
                    { name: "Sony Center", category: "attractions", district: "Mitte", lat: 52.5090, lon: 13.3750, description: "Spettacolare cortile coperto da tetto di vetro e acciaio", specialty: "Illuminazione notturna cangiante", ranking: "good", day: 1 },
                    { name: "Topographie des Terrors", category: "attractions", district: "Mitte", lat: 52.5065, lon: 13.3835, description: "Museo sul sito dell'ex quartier generale della Gestapo", specialty: "Ingresso gratuito", ranking: "top", day: 1 },
                    { name: "Checkpoint Charlie", category: "attractions", district: "Mitte", lat: 52.5075, lon: 13.3903, description: "Il pi√π celebre punto di passaggio della Guerra Fredda", specialty: "Mostra fotografica all'aperto", ranking: "top", day: 1 },
                    { name: "DDR Museum", category: "attractions", district: "Mitte", lat: 52.5191, lon: 13.4018, description: "Museo interattivo sulla vita nella Germania Est", specialty: "Esperienza interattiva", ranking: "good", day: 1 },
                    { name: "Gendarmenmarkt", category: "attractions", district: "Mitte", lat: 52.5137, lon: 13.3928, description: "Una delle piazze pi√π belle d'Europa", specialty: "Illuminazione serale spettacolare", ranking: "top", day: 1 },
                    { name: "Bebelplatz", category: "attractions", district: "Mitte", lat: 52.5168, lon: 13.3933, description: "Piazza storica famosa per il rogo dei libri del 1933", specialty: "Memoriale sotterraneo 'Biblioteca vuota'", ranking: "top", day: 1 },
                    { name: "Pariser Platz", category: "attractions", district: "Mitte", lat: 52.5162, lon: 13.3775, description: "Severa ed elegante piazza con ambasciate", specialty: "Architettura diplomatica", ranking: "good", day: 1 },
                    { name: "Hotel Adlon", category: "attractions", district: "Mitte", lat: 52.5161, lon: 13.3777, description: "Leggendario hotel di lusso sulla Pariser Platz", specialty: "Hotel storico di celebrit√†", ranking: "good", day: 1 },

                    // Giorno 2 - Il Muro (MODIFICATO)
                    { name: "Museumsinsel", category: "attractions", district: "Mitte", lat: 52.5204, lon: 13.3970, description: "Isola dei musei con 5 musei di fama mondiale, patrimonio UNESCO", specialty: "Patrimonio mondiale UNESCO", ranking: "top", day: 2 },
                    { name: "Neues Museum", category: "attractions", district: "Mitte", lat: 52.5197, lon: 13.3985, description: "Museo che ospita il busto di Nefertiti", specialty: "Busto di Nefertiti e tesoro di Troia", ranking: "top", day: 2 },
                    { name: "Pergamonmuseum", category: "attractions", district: "Mitte", lat: 52.5212, lon: 13.3966, description: "Famoso per la Porta di Ishtar di Babilonia", specialty: "Porta di Ishtar", ranking: "top", day: 2 },
                    { name: "Gedenkst√§tte Berliner Mauer", category: "attractions", district: "Mitte", lat: 52.5354, lon: 13.3901, description: "Memoriale centrale della divisione tedesca", specialty: "1,4 km di Muro originale", ranking: "top", day: 2 },
                    { name: "Tr√§nenpalast", category: "attractions", district: "Mitte", lat: 52.5225, lon: 13.3888, description: "Ex padiglione di frontiera, museo degli addii", specialty: "Storia emotiva della divisione", ranking: "top", day: 2 },
                    { name: "East Side Gallery", category: "attractions", district: "Friedrichshain", lat: 52.5050, lon: 13.4394, description: "La pi√π grande galleria d'arte a cielo aperto del mondo", specialty: "1,3 km di Muro dipinto", ranking: "top", day: 2 },
                    { name: "Hackescher Markt", category: "attractions", district: "Scheunenviertel", lat: 52.5220, lon: 13.4025, description: "Vivace piazza con stazione S-Bahn storica e vita notturna", specialty: "Centro della vita notturna dello Scheunenviertel", ranking: "good", day: 2 },
                    { name: "Hackesche H√∂fe", category: "attractions", district: "Scheunenviertel", lat: 52.5225, lon: 13.4016, description: "Famoso complesso di cortili restaurati", specialty: "Architettura Jugendstil", ranking: "good", day: 2 },
                    { name: "Neue Synagoge", category: "attractions", district: "Scheunenviertel", lat: 52.5248, lon: 13.3953, description: "Cupola dorata simbolo della rinascita ebraica", specialty: "Cupola dorata", ranking: "good", day: 2 },
                    { name: "Berliner Dom", category: "attractions", district: "Mitte", lat: 52.5191, lon: 13.4009, description: "Imponente chiesa neorinascimentale con cupola panoramica", specialty: "Vista panoramica dalla cupola", ranking: "good", day: 2 },
                    { name: "Alexanderplatz", category: "attractions", district: "Mitte", lat: 52.5219, lon: 13.4132, description: "Piazza centrale con Fernsehturm e Weltzeituhr", specialty: "Orologio mondiale", ranking: "good", day: 2 },
                    { name: "Cl√§rchens Ballhaus", category: "attractions", district: "Scheunenviertel", lat: 52.5235, lon: 13.4005, description: "Storica sala da ballo del 1913", specialty: "Serata danzante autentica", ranking: "good", day: 2 },

                    // Giorno 3 - L'Olocausto (MODIFICATO)
                    { name: "Museum f√ºr Naturkunde", category: "attractions", district: "Scheunenviertel", lat: 52.5308, lon: 13.3815, description: "Museo con il Brachiosaurus pi√π grande del mondo", specialty: "Scheletro di T-Rex Tristan Otto", ranking: "top", day: 3 },
                    { name: "J√ºdisches Museum", category: "attractions", district: "Kreuzberg", lat: 52.5025, lon: 13.3948, description: "Museo della storia ebraica in edificio di Libeskind", specialty: "Architettura di Daniel Libeskind", ranking: "top", day: 3 },
                    { name: "Anne Frank Zentrum", category: "attractions", district: "Scheunenviertel", lat: 52.5225, lon: 13.4016, description: "Mostra sulla storia di Anna Frank", specialty: "Storia parallela con il '900", ranking: "top", day: 3 },
                    { name: "RAW-Gel√§nde", category: "attractions", district: "Friedrichshain", lat: 52.5095, lon: 13.4550, description: "Ex complesso industriale, centro culturale alternativo", specialty: "Cultura underground", ranking: "good", day: 3 },
                    { name: "Oberbaumbr√ºcke", category: "attractions", district: "Friedrichshain", lat: 52.5018, lon: 13.4456, description: "Ponte simbolo che collega Friedrichshain e Kreuzberg", specialty: "Architettura gotica in mattoni", ranking: "good", day: 3 },
                    { name: "Karl-Marx-Allee", category: "attractions", district: "Friedrichshain", lat: 52.5150, lon: 13.4500, description: "Imponente viale monumentale socialista", specialty: "Architettura socialista", ranking: "good", day: 3 },
                    { name: "Boxhagener Platz", category: "attractions", district: "Friedrichshain", lat: 52.5128, lon: 13.4535, description: "Piazza centrale di Friedrichshain con mercato e ristoranti", specialty: "Mercato del sabato", ranking: "good", day: 3 },
                    { name: "Simon-Dach-Strasse", category: "attractions", district: "Friedrichshain", lat: 52.5135, lon: 13.4545, description: "Strada della vita notturna di Friedrichshain con bar e locali", specialty: "Vita notturna alternativa", ranking: "good", day: 3 },

                    // Giorno 4 e Altri (INVARIATO)
                    { name: "Tempelhofer Feld", category: "attractions", district: "Tempelhof", lat: 52.4732, lon: 13.4026, description: "Ex aeroporto di Tempelhof, oggi parco pubblico", specialty: "Piste dell'ex aeroporto", ranking: "good", day: 4 },
                    { name: "Bergmannstrasse", category: "attractions", district: "Kreuzberg", lat: 52.4950, lon: 13.3950, description: "Strada dello shopping nel lato gentrificato di Kreuzberg", specialty: "Shopping e caff√®", ranking: "good", day: 4 },
                    { name: "Schloss Charlottenburg", category: "attractions", district: "Charlottenburg", lat: 52.5209, lon: 13.2956, description: "La pi√π grande residenza reale di Berlino", specialty: "Palazzo barocco e giardini", ranking: "top", day: 4 },
                    { name: "Kaiser-Wilhelm-Ged√§chtniskirche", category: "attractions", district: "Charlottenburg", lat: 52.5049, lon: 13.3350, description: "Chiesa bombardata, simbolo contro la guerra", specialty: "Rovine come memoriale", ranking: "top", day: 4 },
                    { name: "Kurf√ºrstendamm", category: "attractions", district: "Charlottenburg", lat: 52.5025, lon: 13.3275, description: "Viale dello shopping di lusso della Berlino Ovest", specialty: "Shopping di lusso", ranking: "good", day: 4 },
                    { name: "KaDeWe", category: "attractions", district: "Charlottenburg", lat: 52.5025, lon: 13.3420, description: "Il pi√π grande e famoso grande magazzino della Germania", specialty: "Piano gourmet al 6¬∞ piano", ranking: "good", day: 4 },
                    { name: "Marheineke Markthalle", category: "attractions", district: "Kreuzberg", lat: 52.4932, lon: 13.3947, description: "Mercato coperto storico per shopping gastronomico", specialty: "Mercato gastronomico", ranking: "good", day: 4 },

                    // Altre attrazioni importanti
                    { name: "Fernsehturm", category: "attractions", district: "Mitte", lat: 52.5208, lon: 13.4094, description: "Torre della TV alta 368m, simbolo di Berlino", specialty: "Vista panoramica a 360¬∞", ranking: "top", day: 1 },
                    { name: "Alexanderplatz", category: "attractions", district: "Mitte", lat: 52.5219, lon: 13.4132, description: "Piazza centrale con Fernsehturm e Weltzeituhr", specialty: "Orologio mondiale", ranking: "good", day: 1 },
                    { name: "Tiergarten", category: "attractions", district: "Mitte", lat: 52.5145, lon: 13.3501, description: "Vasto parco urbano nel cuore di Berlino", specialty: "Polmone verde della citt√†", ranking: "good", day: 1 },
                    { name: "Deutsches Historisches Museum", category: "attractions", district: "Mitte", lat: 52.5179, lon: 13.3969, description: "2000 anni di storia tedesca nell'ex arsenale", specialty: "Storia tedesca completa", ranking: "good", day: 2 },
                    { name: "Mauerpark", category: "attractions", district: "Prenzlauer Berg", lat: 52.5407, lon: 13.4026, description: "Parco sulla ex striscia della morte con karaoke domenicale", specialty: "Karaoke domenicale", ranking: "good", day: 3 },
                    { name: "Nikolaiviertel", category: "attractions", district: "Nikolaiviertel", lat: 52.5170, lon: 13.4070, description: "Quartiere medievale ricostruito, culla storica di Berlino", specialty: "Architettura medievale ricostruita", ranking: "good", day: 1 },
                    { name: "Astra Kulturhaus", category: "attractions", district: "Friedrichshain", lat: 52.5140, lon: 13.4580, description: "Centro culturale per concerti e eventi nel quartiere alternativo", specialty: "Concerti e cultura underground", ranking: "good", day: 3 }
                ]
            };

            // Itinerari dettagliati MODIFICATI
            const detailedItineraries = {
         day1: {
    title: "Giorno 1: I Grandi Simboli e la Germania Divisa",
    description: "I monumenti pi√π iconici di Berlino e l'esperienza della divisione",
    color: "#667eea",
    theme: "Un viaggio attraverso i simboli del potere e le testimonianze della divisione, culminando con l'illuminazione del Sony Center al tramonto.",
    fullDescription: `
        <h4>üåÖ Mattina (9:00 - 13:30): Il Cuore del Potere Tedesco</h4>
        <div class="itinerary-section">
            <strong>1. Reichstag (9:00):</strong> Inizia la giornata con il simbolo della democrazia tedesca. La sua storia √® un microcosmo della storia tedesca: dalla proclamazione della Repubblica di Weimar nel 1918, all'incendio del 1933 che spian√≤ la strada a Hitler, fino all'iconico "impacchettamento" dell'artista Christo nel 1995.
            <div class="tip">üí° <strong>Consiglio:</strong> La visita alla cupola di vetro di Norman Foster √® gratuita ma va prenotata online con largo anticipo sul sito ufficiale del Bundestag. La vista a 360¬∞ sulla citt√† √® mozzafiato.</div>
        </div>
        <div class="itinerary-section">
            <strong>2. Porta di Brandeburgo (10:30):</strong> A pochi passi dal Reichstag, attraversa l'iconica porta, un tempo simbolo della divisione e oggi della riunificazione.
        </div>
        <div class="itinerary-section">
            <strong>3. Pariser Platz (10:45):</strong> Passeggia per la severa ed elegante piazza, ammirando le facciate delle ambasciate.
        </div>
        <div class="itinerary-section">
            <strong>4. Hotel Adlon (10:50):</strong> Ammira il leggendario hotel di lusso sulla Pariser Platz.
        </div>
        <div class="itinerary-section">
            <strong>5. Holocaust Mahnmal (11:30):</strong> Procedi verso sud per questa tappa toccante e necessaria. Perditi tra le 2711 stele di cemento del campo ondulato progettato da Peter Eisenman.
            <div class="tip">üí° <strong>Consiglio:</strong> Visitate il centro informazioni sotterraneo (ingresso gratuito). La "Sala dei Nomi" √® un'esperienza emotivamente forte ma fondamentale.</div>
        </div>
        <div class="itinerary-section">
            <strong>6. Potsdamer Platz (12:30):</strong> Esplora la piazza che simboleggia la "Nuova Berlino". Un tempo il cuore pulsante della citt√†, fu rasa al suolo e divisa dal Muro.
        </div>
        
        <h4>üçΩÔ∏è Pranzo (13:30 - 14:30): Pausa Gourmet</h4>
        <div class="itinerary-section">
            <strong>7. Weilands Wellfood (13:30):</strong> Opzioni sane e veloci a Potsdamer Platz, perfetto per una pausa rigenerante con piatti salutari.
        </div>
        
        <h4>üèõÔ∏è Pomeriggio (14:30 - 18:15): Guerra Fredda e Memoria</h4>
        <div class="itinerary-section">
            <strong>8. Topographie des Terrors (14:30):</strong> A 5 minuti a piedi da Potsdamer Platz, questo museo gratuito si trova esattamente sul sito dell'ex quartier generale della Gestapo e delle SS.
            <div class="tip">üí° <strong>Consiglio:</strong> La mostra all'aperto √® gratuita e molto ben documentata. Dedicate almeno 45 minuti alla visita.</div>
        </div>
        <div class="itinerary-section">
            <strong>9. Checkpoint Charlie (15:30):</strong> Il pi√π famoso punto di passaggio tra Est e Ovest. La mostra fotografica all'aperto √® il modo migliore per capirne la storia.
        </div>
        <div class="itinerary-section">
            <strong>10. DDR Museum (16:00):</strong> Museo interattivo sulla vita quotidiana nella Germania Est. Un'esperienza coinvolgente che ti far√† comprendere com'era vivere dall'altra parte del Muro.
        </div>
        <div class="itinerary-section">
            <strong>11. Nikolaiviertel (16:45):</strong> Passeggiata nel quartiere medievale ricostruito, la culla storica di Berlino. Questo piccolo borgo ricostruito negli anni '80 offre un assaggio dell'atmosfera antica della citt√†.
            <div class="tip">üí° <strong>Consiglio:</strong> Perfetto per una breve passeggiata di 30 minuti. Ideale per foto suggestive.</div>
        </div>
        <div class="itinerary-section">
            <strong>12. Gendarmenmarkt (17:30):</strong> Una delle piazze pi√π belle d'Europa, ammirando il Konzerthaus e le due cattedrali gemelle.
        </div>
        <div class="itinerary-section">
            <strong>13. Bebelplatz (17:45):</strong> A pochi passi dalla Gendarmenmarkt, questa piazza √® tristemente famosa per il rogo dei libri del 10 maggio 1933. Nel centro della piazza, una targa di vetro consente di vedere la "Biblioteca vuota" sotterranea.
            <div class="tip">üí° <strong>Memoriale:</strong> La biblioteca vuota di Micha Ullman con scaffali per 20.000 libri ricorda i volumi bruciati dai nazisti.</div>
        </div>
        
        <h4>üåÜ Imbrunire (18:15 - 19:00): Spettacolo di Luci</h4>
        <div class="itinerary-section">
            <strong>14. Sony Center (18:15):</strong> Tornate a Potsdamer Platz per ammirare il Sony Center al tramonto. Il suo spettacolare cortile coperto da un tetto di vetro e acciaio si illumina di colori cangianti mentre cala la sera.
            <div class="tip">üí° <strong>Consiglio:</strong> Questo √® il momento migliore per fotografare il Sony Center e godersi l'aperitivo in uno dei suoi caff√®.</div>
        </div>
        
        <h4>üåÉ Cena e Serata (dalle 19:30)</h4>
        <div class="itinerary-section">
            <strong>15. Augustiner am Gendarmenmarkt (19:30):</strong> Cena con atmosfera autentica bavarese nella splendida piazza.<br>
            <strong>Dopocena:</strong> Passeggiata nella Gendarmenmarkt illuminata.
        </div>
    `,
    places: [
        { name: "Reichstag", time: "9:00", type: "attraction" },
        { name: "Porta di Brandeburgo", time: "10:30", type: "attraction" },
        { name: "Pariser Platz", time: "10:45", type: "attraction" },
        { name: "Hotel Adlon", time: "10:50", type: "attraction" },
        { name: "Holocaust Mahnmal", time: "11:30", type: "attraction" },
        { name: "Potsdamer Platz", time: "12:30", type: "attraction" },
        { name: "Weilands Wellfood", time: "13:30", type: "lunch" },
        { name: "Topographie des Terrors", time: "14:30", type: "attraction" },
        { name: "Checkpoint Charlie", time: "15:30", type: "attraction" },
        { name: "DDR Museum", time: "16:00", type: "attraction" },
        { name: "Nikolaiviertel", time: "16:45", type: "attraction" },
        { name: "Gendarmenmarkt", time: "17:30", type: "attraction" },
        { name: "Bebelplatz", time: "17:45", type: "attraction" },
        { name: "Sony Center", time: "18:15", type: "attraction" },
        { name: "Augustiner am Gendarmenmarkt", time: "19:30", type: "dinner" }
    ]
},
                day2: {
    title: "Giorno 2: Tesori Antichi e Tracce del Muro",
    description: "Dai capolavori dell'antichit√† alla storia della divisione di Berlino",
    color: "#00b894",
    theme: "Un viaggio attraverso i tesori dell'antichit√† e le testimonianze fisiche ed emotive della divisione berlinese.",
    fullDescription: `
        <h4>üè∫ Mattina (9:30 - 13:00): I Tesori dell'Isola dei Musei</h4>
        <div class="itinerary-section">
            <strong>1. Museumsinsel (9:30):</strong> Dedicate la mattinata a questo sito UNESCO con 5 musei di fama mondiale. Concentratevi sui due imperdibili.
        </div>
        <div class="itinerary-section">
            <strong>2. Neues Museum (10:00):</strong> La tappa obbligatoria per vedere il busto di Nefertiti. Il museo stesso √® un'opera d'arte dopo il restauro di David Chipperfield. Esplorate la collezione egizia e il "tesoro di Troia".
            <div class="tip">üí° <strong>Consiglio:</strong> Acquistate i biglietti online per una fascia oraria specifica. La mattina √® meno affollata.</div>
        </div>
        <div class="itinerary-section">
            <strong>3. Pergamonmuseum (11:30):</strong> La Porta di Ishtar di Babilonia e l'Altare di Pergamo valgono da soli la visita.
        </div>
        <div class="itinerary-section">
            <strong>4. Berliner Dom (12:30):</strong> Breve visita all'imponente cattedrale, magari salita alla cupola per la vista panoramica.
        </div>
        
        <h4>üçú Pranzo (13:00 - 14:00): Sapori dal Mondo</h4>
        <div class="itinerary-section">
            <strong>5. Berliner Republik (13:00):</strong> Pub vivace sulla Sprea con vista sul fiume, perfetto per una pausa pranzo prima del pomeriggio dedicato alla storia del Muro.
        </div>
        
        <h4>üß± Pomeriggio (14:00 - 18:30): Il Muro e le Sue Storie</h4>
        <div class="itinerary-section">
            <strong>6. Gedenkst√§tte Berliner Mauer (14:00):</strong> Il luogo migliore per capire la brutalit√† e la complessit√† del Muro. Il memoriale si estende per 1,4 km lungo Bernauer Strasse e include un tratto originale del Muro con la "striscia della morte".
        </div>
        <div class="itinerary-section">
            <strong>7. Tr√§nenpalast (15:30):</strong> L'ex padiglione di frontiera dove avvenivano i commoventi addii tra Est e Ovest. Un museo toccante sulla divisione delle famiglie.
        </div>
        <div class="itinerary-section">
            <strong>8. East Side Gallery (16:30):</strong> Passeggiate lungo il tratto di Muro pi√π lungo rimasto in piedi (1,3 km), trasformato nella pi√π grande galleria d'arte all'aperto del mondo.
        </div>
        <div class="itinerary-section">
            <strong>9. Alexanderplatz (17:30):</strong> Concludete con la famosa piazza centrale di Berlino Est, dominata dalla Fernsehturm. Ammirate il Weltzeituhr (orologio mondiale) e l'atmosfera socialista ancora palpabile.
            <div class="tip">üí° <strong>Consiglio:</strong> Se avete energia, salite sulla Fernsehturm per una vista a 360¬∞ sulla citt√† (prenotazione consigliata).</div>
        </div>
        <div class="itinerary-section">
            <strong>10. Hackescher Markt (18:00):</strong> Vivace piazza con la storica stazione S-Bahn e punto di partenza per esplorare lo Scheunenviertel. L'area √® piena di caff√®, bar e negozi alla moda.
        </div>
        <div class="itinerary-section">
            <strong>11. Hackesche H√∂fe (18:15):</strong> A pochi passi da Hackescher Markt, rilassatevi passeggiando attraverso il famoso complesso di cortili restaurati, perfetto esempio di architettura Jugendstil.
        </div>
        <div class="itinerary-section">
            <strong>12. Neue Synagoge (18:30):</strong> Ammirate la cupola dorata, simbolo della rinascita della comunit√† ebraica berlinese.
        </div>
        
        <h4>üçΩÔ∏è Cena e Serata (dalle 19:30)</h4>
        <div class="itinerary-section">
            <strong>13. Katz Orange (19:30):</strong> Cena con un'atmosfera magica in un ex birrificio con cucina "dalla fattoria alla tavola".<br>
            <strong>14. Cl√§rchens Ballhaus (21:30):</strong> Dopocena nella storica sala da ballo del 1913 per un'esperienza autentica di danza berlinese.
        </div>
    `,
    places: [
        { name: "Museumsinsel", time: "9:30", type: "attraction" },
        { name: "Neues Museum", time: "10:00", type: "attraction" },
        { name: "Pergamonmuseum", time: "11:30", type: "attraction" },
        { name: "Berliner Dom", time: "12:30", type: "attraction" },
        { name: "Berliner Republik", time: "13:00", type: "lunch" },
        { name: "Gedenkst√§tte Berliner Mauer", time: "14:00", type: "attraction" },
        { name: "Tr√§nenpalast", time: "15:30", type: "attraction" },
        { name: "East Side Gallery", time: "16:30", type: "attraction" },
        { name: "Alexanderplatz", time: "17:30", type: "attraction" },
        { name: "Hackescher Markt", time: "18:00", type: "attraction" },
        { name: "Hackesche H√∂fe", time: "18:15", type: "attraction" },
        { name: "Neue Synagoge", time: "18:30", type: "attraction" },
        { name: "Katz Orange", time: "19:30", type: "dinner" },
        { name: "Cl√§rchens Ballhaus", time: "21:30", type: "evening" }
    ]
},
                day3: {
    title: "Giorno 3: Scienza, Memoria e Storia Ebraica",
    description: "Dalla meraviglia scientifica alla riflessione sull'Olocausto",
    color: "#e17055",
    theme: "Un viaggio dalla meraviglia scientifica alla memoria dell'Olocausto, esplorando la storia ebraica attraverso musei toccanti e significativi.",
    fullDescription: `
        <h4>ü¶ï Mattina (9:30 - 13:00): Un Viaggio nella Preistoria</h4>
        <div class="itinerary-section">
            <strong>1. Museum f√ºr Naturkunde (9:30):</strong> Iniziate la giornata con una dose di meraviglia! Preparatevi a restare a bocca aperta davanti allo scheletro di Brachiosaurus brancai, il pi√π grande dinosauro montato del mondo. Non perdete lo scheletro di T-Rex "Tristan Otto", uno dei pi√π completi mai trovati.
            <div class="tip">üí° <strong>Consiglio:</strong> Arrivare all'apertura (9:30) √® fondamentale per evitare la folla e godersi i dinosauri in pace. Dedicate almeno 2.5 ore alla visita.</div>
        </div>
        
        <h4>üçú Pranzo (13:00 - 14:00): Pausa Energetica</h4>
        <div class="itinerary-section">
            <strong>2. Cocolo Ramenbar (13:00):</strong> Il miglior ramen bar della citt√† per ricaricare le energie con noodle fatti in casa e brodo perfetto.
        </div>
        
        <h4>‚ú°Ô∏è Pomeriggio (14:00 - 18:30): Memoria dell'Olocausto e Cultura Ebraica</h4>
        <div class="itinerary-section">
            <strong>3. J√ºdisches Museum (14:00):</strong> Un'esperienza architettonica e storica unica. L'edificio di Daniel Libeskind √® esso stesso un racconto della storia ebraica attraverso la sua architettura decostruttivista. Percorrete 2000 anni di storia ebraico-tedesca.
            <div class="tip">üí° <strong>Consiglio:</strong> L'edificio stesso racconta una storia attraverso la sua architettura. La Torre dell'Olocausto e il Giardino dell'Esilio sono particolarmente toccanti.</div>
        </div>
        <div class="itinerary-section">
            <strong>4. Anne Frank Zentrum (16:00):</strong> Piccolo ma significativo centro che racconta la storia di Anna Frank in parallelo con la storia del '900. Un momento di grande impatto emotivo che collega la storia personale a quella mondiale.
        </div>
        <div class="itinerary-section">
            <strong>5. Mauerpark (17:00):</strong> Dopo l'intensit√† emotiva dei musei, rilassatevi in questo parco costruito sulla ex striscia della morte del Muro di Berlino. Un luogo simbolico di trasformazione da divisione a unione.
        </div>
        <div class="itinerary-section">
            <strong>6. RAW-Gel√§nde (17:45):</strong> Ex complesso industriale trasformato in centro culturale alternativo. Perfetto per scoprire la cultura underground berlinese.
        </div>
        <div class="itinerary-section">
            <strong>7. Oberbaumbr√ºcke (18:15):</strong> Il ponte simbolo che collega Friedrichshain e Kreuzberg con la sua spettacolare architettura gotica in mattoni. Perfetto per foto al tramonto.
        </div>
        <div class="itinerary-section">
            <strong>8. Boxhagener Platz (18:30):</strong> Piazza centrale di Friedrichshain, cuore pulsante del quartiere alternativo.
        </div>
        
        <h4>üçΩÔ∏è Cena e Serata (dalle 19:30)</h4>
        <div class="itinerary-section">
            <strong>9. Schneeweiss (19:30):</strong> Cena con cucina alpina moderna in ambiente elegante, perfetta dopo una giornata intensa di riflessione.<br>
            <strong>10. Simon-Dach-Strasse (21:30):</strong> Dopocena tra i bar alternativi della strada della vita notturna di Friedrichshain per assaporare la Berlino notturna e alleggerire l'umore dopo una giornata di riflessione.
        </div>
    `,
    places: [
        { name: "Museum f√ºr Naturkunde", time: "9:30", type: "attraction" },
        { name: "Cocolo Ramenbar", time: "13:00", type: "lunch" },
        { name: "J√ºdisches Museum", time: "14:00", type: "attraction" },
        { name: "Anne Frank Zentrum", time: "16:00", type: "attraction" },
        { name: "Mauerpark", time: "17:00", type: "attraction" },
        { name: "RAW-Gel√§nde", time: "17:45", type: "attraction" },
        { name: "Oberbaumbr√ºcke", time: "18:15", type: "attraction" },
        { name: "Boxhagener Platz", time: "18:30", type: "attraction" },
        { name: "Schneeweiss", time: "19:30", type: "dinner" },
        { name: "Simon-Dach-Strasse", time: "21:30", type: "evening" }
    ]
},
                day4: {
    title: "Giorno 4: Un Doveroso Viaggio nella Memoria e Shopping d'Addio",
    description: "Una visita toccante e un pomeriggio pi√π leggero",
    color: "#6c5ce7",
    theme: "Una visita toccante al campo di concentramento, seguita da un pomeriggio pi√π leggero per salutare Berlino.",
    fullDescription: `
        <h4>üïØÔ∏è Mattina (9:00 - 14:00): Gita a Sachsenhausen</h4>
        <div class="itinerary-section">
            <strong>1. Campo di Concentramento di Sachsenhausen (9:00):</strong> Dedicate la mattinata a questa importante gita fuori porta a Oranienburg. √à una visita emotivamente molto intensa ma fondamentale per comprendere la storia.
            <div class="tip">üí° <strong>Consiglio:</strong> L'audioguida (‚Ç¨3, in italiano) √® essenziale per comprendere appieno la storia. Partite presto per avere tempo sufficiente.</div>
        </div>
        
        <h4>üçΩÔ∏è Pranzo (14:00 - 15:00): Rientro a Berlino</h4>
        <div class="itinerary-section">
            <strong>2. Pranzo veloce (14:00):</strong> Potete mangiare qualcosa di veloce vicino alla stazione di Oranienburg o rientrare a Berlino per il pranzo.
        </div>
        
        <h4>üõçÔ∏è Pomeriggio (15:00 - 18:30): Shopping e Addii</h4>
        <div class="itinerary-section">
            <strong>3. Bergmannstrasse (15:00):</strong> Dedicate l'ultimo pomeriggio a un po' di relax e shopping nella strada del lato gentrificato di Kreuzberg, perfetta per acquisti e souvenir.
        </div>
        <div class="itinerary-section">
            <strong>4. Marheineke Markthalle (16:00):</strong> Visitate questo mercato coperto storico per shopping gastronomico e prodotti locali.
        </div>
        <div class="itinerary-section">
            <strong>5. Tempelhofer Feld (16:45):</strong> Breve visita al famoso ex aeroporto di Tempelhof, oggi parco pubblico. Un luogo simbolico della storia berlinese.
        </div>
        <div class="itinerary-section">
            <strong>6. Kaiser-Wilhelm-Ged√§chtniskirche (17:30):</strong> La chiesa bombardata, simbolo contro la guerra, nel cuore della Berlino Ovest.
        </div>
        <div class="itinerary-section">
            <strong>7. Kurf√ºrstendamm (18:00):</strong> Passeggiata lungo il viale dello shopping di lusso della Berlino Ovest.
        </div>
        <div class="itinerary-section">
            <strong>8. KaDeWe (18:15):</strong> Il pi√π grande e famoso grande magazzino della Germania. Il piano gourmet al 6¬∞ piano √® imperdibile.
        </div>
        
        <h4>üçó Cena d'Addio (dalle 19:30)</h4>
        <div class="itinerary-section">
            <strong>9. Henne (19:30):</strong> Cena d'addio con il leggendario pollo arrosto dal 1907. Un locale storico che serve solo mezzo pollo arrosto da oltre un secolo.
            <div class="tip">üí° <strong>Importante:</strong> Prenotazione obbligatoria! Chiamate in anticipo per assicurarvi un tavolo per questa esperienza culinaria unica.</div>
        </div>
    `,
    places: [
        { name: "Campo di Concentramento di Sachsenhausen", time: "9:00", type: "attraction" },
        { name: "Pranzo a Oranienburg", time: "14:00", type: "lunch" },
        { name: "Bergmannstrasse", time: "15:00", type: "attraction" },
        { name: "Marheineke Markthalle", time: "16:00", type: "attraction" },
        { name: "Tempelhofer Feld", time: "16:45", type: "attraction" },
        { name: "Kaiser-Wilhelm-Ged√§chtniskirche", time: "17:30", type: "attraction" },
        { name: "Kurf√ºrstendamm", time: "18:00", type: "attraction" },
        { name: "KaDeWe", time: "18:15", type: "attraction" },
        { name: "Henne", time: "19:30", type: "dinner" }
    ]
}
            };

            // Quartieri con coordinate dei confini - COMPLETI
            const districts = {
                "Mitte": { 
                    description: "Il cuore storico e monumentale di Berlino", 
                    color: "#667eea",
                    bounds: [
                        [52.5350, 13.3650], [52.5350, 13.4100], [52.5100, 13.4200], 
                        [52.4950, 13.4050], [52.4950, 13.3750], [52.5150, 13.3650]
                    ]
                },
                "Kreuzberg": { 
                    description: "Quartiere alternativo e multiculturale", 
                    color: "#e17055",
                    bounds: [
                        [52.5100, 13.3900], [52.5100, 13.4300], [52.4800, 13.4400], 
                        [52.4700, 13.4100], [52.4800, 13.3800], [52.5000, 13.3900]
                    ]
                },
                "Prenzlauer Berg": { 
                    description: "Quartiere boh√©mien e famiglie", 
                    color: "#00b894",
                    bounds: [
                        [52.5350, 13.4000], [52.5450, 13.4300], [52.5350, 13.4400], 
                        [52.5250, 13.4300], [52.5200, 13.4100], [52.5300, 13.4000]
                    ]
                },
                "Friedrichshain": { 
                    description: "Zona giovane e artistica", 
                    color: "#fdcb6e",
                    bounds: [
                        [52.5200, 13.4200], [52.5300, 13.4700], [52.4950, 13.4800], 
                        [52.4850, 13.4500], [52.5050, 13.4300], [52.5150, 13.4200]
                    ]
                },
                "Charlottenburg": { 
                    description: "Elegante Berlino Ovest", 
                    color: "#e84393",
                    bounds: [
                        [52.5300, 13.2800], [52.5400, 13.3400], [52.5000, 13.3500], 
                        [52.4900, 13.3200], [52.5100, 13.2700], [52.5300, 13.2800]
                    ]
                },
                "Scheunenviertel": { 
                    description: "Quartiere ebraico storico", 
                    color: "#6c5ce7",
                    bounds: [
                        [52.5200, 13.3900], [52.5300, 13.4100], [52.5250, 13.4150], 
                        [52.5150, 13.4050], [52.5150, 13.3950], [52.5200, 13.3900]
                    ]
                },
                "Nikolaiviertel": { 
                    description: "Quartiere medievale ricostruito", 
                    color: "#fd79a8",
                    bounds: [
                        [52.5160, 13.4050], [52.5180, 13.4090], [52.5150, 13.4100], 
                        [52.5140, 13.4060], [52.5150, 13.4040], [52.5160, 13.4050]
                    ]
                },
                "Alexanderplatz": { 
                    description: "Centro commerciale e dei trasporti", 
                    color: "#a29bfe",
                    bounds: [
                        [52.5200, 13.4100], [52.5240, 13.4180], [52.5180, 13.4200], 
                        [52.5160, 13.4140], [52.5180, 13.4080], [52.5200, 13.4100]
                    ]
                },
                "Tempelhof": { 
                    description: "Quartiere dell'ex aeroporto", 
                    color: "#55a3ff",
                    bounds: [
                        [52.4800, 13.3900], [52.4850, 13.4200], [52.4650, 13.4300], 
                        [52.4600, 13.4000], [52.4700, 13.3800], [52.4800, 13.3900]
                    ]
                },
                "Tiergarten": { 
                    description: "Quartiere governativo e parco centrale", 
                    color: "#55a3ff",
                    bounds: [
                        [52.5200, 13.3400], [52.5250, 13.3800], [52.5100, 13.3900], 
                        [52.5050, 13.3650], [52.5150, 13.3500], [52.5200, 13.3400]
                    ]
                }
            };

            // Inizializza la mappa Leaflet
            const map = L.map('map', { zoomControl: false }).setView([52.5200, 13.4050], 12);

            // Crea layer dei quartieri
            const districtLayers = {};
            const districtLayerGroup = L.layerGroup();
            
            Object.entries(districts).forEach(([name, district]) => {
                const polygon = L.polygon(district.bounds, {
                    color: district.color,
                    fillColor: district.color,
                    fillOpacity: 0.2,
                    weight: 2,
                    opacity: 0.6
                }).bindPopup(`
                    <div style="text-align: center;">
                        <h3 style="margin: 0 0 5px 0; color: ${district.color};">${name}</h3>
                        <p style="margin: 0; font-size: 0.9em;">${district.description}</p>
                    </div>
                `);
                
                // Eventi hover per i quartieri
                polygon.on('mouseover', function(e) {
                    if (currentView === 'districts') {
                        this.setStyle({
                            fillOpacity: 0.4,
                            weight: 3,
                            opacity: 0.8
                        });
                    }
                });
                
                polygon.on('mouseout', function(e) {
                    if (currentView === 'districts') {
                        this.setStyle({
                            fillOpacity: 0.2,
                            weight: 2,
                            opacity: 0.6
                        });
                    }
                });
                
                // Click sul quartiere per filtrare
                polygon.on('click', function(e) {
                    if (currentView === 'districts') {
                        filterByDistrict(name);
                        highlightDistrict(name);
                    }
                });
                
                districtLayers[name] = polygon;
                districtLayerGroup.addLayer(polygon);
            });

// Layer fermate principali - Caricamento dinamico da Overpass API
const stationLayer = L.layerGroup();
let allStations = []; // Array per memorizzare tutte le fermate

// Crea le icone per tipo di stazione (MANTIENI questa funzione identica)
function createStationIcon(type) {
    let color, symbol, size;
    
    switch (type) {
        case 's-bahn':
            color = '#00A651'; // Verde S-Bahn
            symbol = 'S';
            size = 24;
            break;
        case 'u-bahn':
            color = '#003399'; // Blu U-Bahn
            symbol = 'U';
            size = 24;
            break;
        case 'both':
            color = '#FF6600'; // Arancione per entrambi
            symbol = '‚äï';
            size = 26;
            break;
        default:
            color = '#666666';
            symbol = '‚Ä¢';
            size = 16;
    }
    
    return L.divIcon({
        className: 'transit-station-icon',
        html: `<div style="
            background-color: ${color};
            color: white;
            width: ${size}px;
            height: ${size}px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: ${size * 0.6}px;
            font-family: 'Poppins', sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
        ">${symbol}</div>`,
        iconSize: [size + 4, size + 4],
        iconAnchor: [(size + 4) / 2, (size + 4) / 2]
    });
}

// Funzione per determinare il quartiere dalla posizione
function getDistrictFromPosition(lat, lon) {
    for (const [districtName, district] of Object.entries(districts)) {
        if (district.bounds && isPointInPolygon([lat, lon], district.bounds)) {
            return districtName;
        }
    }
    
    const distances = Object.entries(districts).map(([name, district]) => {
        if (!district.bounds || district.bounds.length === 0) return { name, distance: Infinity };
        
        const centerLat = district.bounds.reduce((sum, point) => sum + point[0], 0) / district.bounds.length;
        const centerLon = district.bounds.reduce((sum, point) => sum + point[1], 0) / district.bounds.length;
        
        const distance = Math.sqrt(
            Math.pow(lat - centerLat, 2) + Math.pow(lon - centerLon, 2)
        );
        
        return { name, distance };
    });
    
    const closest = distances.reduce((min, current) => 
        current.distance < min.distance ? current : min
    );
    
    return closest.name || 'Berlin';
}

// Funzione helper per verificare se un punto √® dentro un poligono
function isPointInPolygon(point, polygon) {
    const [x, y] = point;
    let inside = false;
    
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
        const [xi, yi] = polygon[i];
        const [xj, yj] = polygon[j];
        
        if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
            inside = !inside;
        }
    }
    
    return inside;
}

// Funzione per scaricare le fermate S-Bahn dall'API Overpass
async function fetchSBahnStations() {
    const query = `
        [out:json][timeout:30];
        (
          node["railway"="station"]["name"~"^S "];
          node["railway"="station"]["ref"~"^S"];
          node["railway"="station"]["public_transport"="station"]["train"="yes"]["name"~"S"];
        );
        out geom;
    `;
    
    try {
        console.log('üöä Scaricando fermate S-Bahn con query semplificata...');
        const response = await fetch('https://overpass-api.de/api/interpreter', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `data=${encodeURIComponent(query)}`
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`‚úÖ Trovate ${data.elements.length} fermate S-Bahn con query semplificata`);
        
        if (data.elements.length === 0) {
            console.log('üöä Query semplificata non ha trovato risultati, motivo possibile:');
            console.log('   - Le stazioni S-Bahn non hanno "S " nel nome in OpenStreetMap');
            console.log('   - Il tagging √® diverso da quello previsto');
            console.log('   - Le stazioni sono mappate diversamente');
        }
        
        const stations = data.elements
            .filter(station => station.tags && station.tags.name)
            .map(station => ({
                name: station.tags.name,
                lat: station.lat,
                lon: station.lon,
                type: 's-bahn',
                lines: station.tags.line || station.tags.ref || 'S-Bahn',
                district: getDistrictFromPosition(station.lat, station.lon),
                operator: station.tags.operator || 'S-Bahn Berlin'
            }));
        
        return stations;
        
    } catch (error) {
        console.error('‚ùå Errore scaricamento S-Bahn:', error);
        console.log('üöä Motivi possibili del fallimento:');
        console.log('   - Timeout della query Overpass');
        console.log('   - Server Overpass temporaneamente non disponibile');
        console.log('   - Query con sintassi non corretta');
        return [];
    }
}

// Funzione per scaricare le fermate U-Bahn dall'API Overpass
async function fetchUBahnStations() {
    const query = `
        [out:json][timeout:30];
        (
          node["railway"="station"]["operator"="BVG"]["network"="VBB"];
          node["railway"="halt"]["operator"="BVG"]["network"="VBB"];
          node["railway"="station"]["subway"="yes"];
          node["railway"="station"]["service"="subway"];
        );
        out geom;
    `;
    
    try {
        console.log('üöá Scaricando fermate U-Bahn...');
        const response = await fetch('https://overpass-api.de/api/interpreter', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `data=${encodeURIComponent(query)}`
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`‚úÖ Trovate ${data.elements.length} fermate U-Bahn`);
        
        return data.elements
            .filter(station => station.tags && station.tags.name) // Solo con nome
            .map(station => ({
                name: station.tags.name,
                lat: station.lat,
                lon: station.lon,
                type: 'u-bahn',
                lines: station.tags.line || station.tags.ref || 'U-Bahn',
                district: getDistrictFromPosition(station.lat, station.lon),
                operator: station.tags.operator || 'BVG'
            }));
        
    } catch (error) {
        console.error('‚ùå Errore scaricamento U-Bahn:', error);
        return [];
    }
}


// Funzione per combinare S-Bahn e U-Bahn e identificare stazioni miste
function combineStations(sBahnStations, uBahnStations) {
    const combinedStations = [];
    const processed = new Set();
    
    // Distanza massima per considerare due fermate come la stessa (in gradi)
    const maxDistance = 0.001; // circa 100 metri
    
    // Aggiungi fermate S-Bahn
    sBahnStations.forEach(sBahn => {
        const nearbyUBahn = uBahnStations.find(uBahn => {
            const distance = Math.sqrt(
                Math.pow(sBahn.lat - uBahn.lat, 2) + 
                Math.pow(sBahn.lon - uBahn.lon, 2)
            );
            return distance < maxDistance;
        });
        
        if (nearbyUBahn) {
            // Stazione combinata
            combinedStations.push({
                name: sBahn.name,
                lat: sBahn.lat,
                lon: sBahn.lon,
                type: 'both',
                lines: `${sBahn.lines}, ${nearbyUBahn.lines}`,
                district: sBahn.district
            });
            processed.add(`${nearbyUBahn.lat},${nearbyUBahn.lon}`);
        } else {
            // Solo S-Bahn
            combinedStations.push(sBahn);
        }
    });
    
    // Aggiungi fermate U-Bahn non ancora processate
    uBahnStations.forEach(uBahn => {
        const key = `${uBahn.lat},${uBahn.lon}`;
        if (!processed.has(key)) {
            combinedStations.push(uBahn);
        }
    });
    
    return combinedStations;
}

// Funzione per caricare le fermate sulla mappa
function loadStationsOnMap(stations) {
    // Pulisci il layer esistente
    stationLayer.clearLayers();
    
    stations.forEach(station => {
        const icon = createStationIcon(station.type);
        
        const marker = L.marker([station.lat, station.lon], {
            icon: icon,
            zIndexOffset: 100
        });
        
        const typeText = station.type === "both" ? "üöáüöä S-Bahn & U-Bahn" : 
                        station.type === "s-bahn" ? "üöä S-Bahn" : "üöá U-Bahn";
        
     marker.bindPopup(`
    <div style="text-align: center; min-width: 200px;">
        <h4 style="margin: 0 0 8px 0; color: #333;">${station.name}</h4>
        <div style="margin: 5px 0; font-weight: 600; color: #666;">
            ${typeText}
        </div>
        <div style="margin: 8px 0; font-size: 0.9em; color: #555;">
            <strong>Linee:</strong> ${station.lines}
        </div>
    </div>
`);
        
        stationLayer.addLayer(marker);
    });
    
    console.log(`‚úÖ Caricate ${stations.length} fermate sulla mappa`);
}

// Funzione principale per inizializzare le fermate
async function initializeStations() {
    try {
        console.log('üöá Inizializzando sistema fermate...');
        
        // Scarica entrambi i tipi di fermate in parallelo
        const [sBahnStations, uBahnStations] = await Promise.all([
            fetchSBahnStations(),
            fetchUBahnStations()
        ]);
        
        console.log('üìç Fermate S-Bahn ricevute: ' + sBahnStations.length);
        console.log('üìç Fermate U-Bahn ricevute: ' + uBahnStations.length);
        
        // Se non abbiamo fermate S-Bahn, usa il fallback garantito
        let finalSBahnStations = sBahnStations;
        if (sBahnStations.length === 0) {
            console.log('üöä Nessuna S-Bahn trovata, usando fallback garantito...');
finalSBahnStations = [
    // === CENTRO STORICO (Mitte) ===
    { name: "Hauptbahnhof", lat: 52.5251, lon: 13.3694, type: "s-bahn", lines: "S3, S5, S7, S9, S41, S42", district: "Mitte" },
    { name: "Friedrichstra√üe", lat: 52.5206, lon: 13.3862, type: "s-bahn", lines: "S1, S2, S5, S25", district: "Mitte" },
    { name: "Brandenburger Tor", lat: 52.5163, lon: 13.3777, type: "s-bahn", lines: "S1, S2, S25", district: "Mitte" },
    { name: "Potsdamer Platz", lat: 52.5096, lon: 13.3758, type: "s-bahn", lines: "S1, S2, S25", district: "Mitte" },
    { name: "Unter den Linden", lat: 52.5174, lon: 13.3888, type: "s-bahn", lines: "S1, S2, S25", district: "Mitte" },
    
    // === SCHEUNENVIERTEL (Quartiere ebraico) ===
    { name: "Hackescher Markt", lat: 52.5220, lon: 13.4017, type: "s-bahn", lines: "S3, S5, S7, S9", district: "Scheunenviertel" },
    { name: "Oranienburger Stra√üe", lat: 52.5248, lon: 13.3953, type: "s-bahn", lines: "S1, S2, S25", district: "Scheunenviertel" },
    
    // === ALEXANDERPLATZ ===
    { name: "Alexanderplatz", lat: 52.5219, lon: 13.4132, type: "s-bahn", lines: "S3, S5, S7, S9, S41, S42", district: "Alexanderplatz" },
    { name: "Jannowitzbr√ºcke", lat: 52.5151, lon: 13.4198, type: "s-bahn", lines: "S3, S5, S7, S9", district: "Alexanderplatz" },
    
    // === FRIEDRICHSHAIN (Zona giovane) ===
    { name: "Ostbahnhof", lat: 52.5107, lon: 13.4346, type: "s-bahn", lines: "S3, S5, S7, S9, S41, S42", district: "Friedrichshain" },
    { name: "Warschauer Stra√üe", lat: 52.5058, lon: 13.4497, type: "s-bahn", lines: "S3, S5, S7, S9, S41, S42", district: "Friedrichshain" },
    { name: "Ostkreuz", lat: 52.5025, lon: 13.4697, type: "s-bahn", lines: "S3, S5, S7, S9, S41, S42, S8, S85", district: "Friedrichshain" },
    { name: "Frankfurter Allee", lat: 52.5147, lon: 13.4695, type: "s-bahn", lines: "S41, S42", district: "Friedrichshain" },
    
    // === PRENZLAUER BERG (Quartiere boh√©mien) ===
    { name: "Prenzlauer Allee", lat: 52.5489, lon: 13.4175, type: "s-bahn", lines: "S8, S85, S41, S42", district: "Prenzlauer Berg" },
    { name: "Greifswalder Stra√üe", lat: 52.5542, lon: 13.4347, type: "s-bahn", lines: "S8, S85", district: "Prenzlauer Berg" },
    { name: "Landsberger Allee", lat: 52.5294, lon: 13.4431, type: "s-bahn", lines: "S8, S85", district: "Prenzlauer Berg" },
    
    // === KREUZBERG (Quartiere alternativo) ===
    { name: "Anhalter Bahnhof", lat: 52.5042, lon: 13.3814, type: "s-bahn", lines: "S1, S2, S25", district: "Kreuzberg" },
    { name: "Yorckstra√üe", lat: 52.4943, lon: 13.3814, type: "s-bahn", lines: "S1, S2, S25, S26", district: "Kreuzberg" },
    { name: "Hallesches Tor", lat: 52.4975, lon: 13.3908, type: "s-bahn", lines: "S1, S2, S25", district: "Kreuzberg" },
    { name: "Treptower Park", lat: 52.4975, lon: 13.4636, type: "s-bahn", lines: "S8, S85, S41, S42", district: "Kreuzberg" },
    
    // === CHARLOTTENBURG (Berlino Ovest elegante) ===
    { name: "Zoologischer Garten", lat: 52.5075, lon: 13.3340, type: "s-bahn", lines: "S3, S5, S7, S9", district: "Charlottenburg" },
    { name: "Savignyplatz", lat: 52.5048, lon: 13.3059, type: "s-bahn", lines: "S3, S5, S7, S9", district: "Charlottenburg" },
    { name: "Charlottenburg", lat: 52.5049, lon: 13.3350, type: "s-bahn", lines: "S3, S5, S7, S9", district: "Charlottenburg" },
    { name: "Westkreuz", lat: 52.5019, lon: 13.2831, type: "s-bahn", lines: "S3, S5, S7, S9", district: "Charlottenburg" },
    { name: "Messe Nord/ICC", lat: 52.5058, lon: 13.2831, type: "s-bahn", lines: "S41, S42", district: "Charlottenburg" },
    
    // === TIERGARTEN (Vicino all'hotel!) ===
    { name: "Bellevue", lat: 52.5200, lon: 13.3478, type: "s-bahn", lines: "S1, S2, S25", district: "Tiergarten" },
    { name: "Tiergarten", lat: 52.5086, lon: 13.3356, type: "s-bahn", lines: "S3, S5, S7, S9", district: "Tiergarten" },
    
// === TIERGARTEN (Vicino all'hotel!) ===
{ name: "Bellevue", lat: 52.5200, lon: 13.3478, type: "s-bahn", lines: "S1, S2, S25", district: "Tiergarten" },
{ name: "Tiergarten", lat: 52.5086, lon: 13.3356, type: "s-bahn", lines: "S3, S5, S7, S9", district: "Tiergarten" },

// === SCH√ñNEBERG (Zona hotel) ===
{ name: "Innsbrucker Platz", lat: 52.4872, lon: 13.3431, type: "s-bahn", lines: "S41, S42, S46", district: "Sch√∂neberg" },

    // === TEMPELHOF ===
    { name: "Tempelhof", lat: 52.4732, lon: 13.3856, type: "s-bahn", lines: "S41, S42, S45, S46", district: "Tempelhof" },
    { name: "S√ºdkreuz", lat: 52.4756, lon: 13.3656, type: "s-bahn", lines: "S2, S25, S26, S41, S42", district: "Tempelhof" },
    
    // === ZONE LIMITROFE STRATEGICHE ===
    { name: "Gesundbrunnen", lat: 52.5489, lon: 13.3889, type: "s-bahn", lines: "S1, S2, S25, S26, S41, S42", district: "Wedding" },
    { name: "Bornholmer Stra√üe", lat: 52.5642, lon: 13.3889, type: "s-bahn", lines: "S1, S2, S8, S85", district: "Pankow" }
];
        }
        
        // Combina e processa le fermate
        allStations = combineStations(finalSBahnStations, uBahnStations);
        
        console.log('üìç Fermate S-Bahn finali: ' + finalSBahnStations.length);
        console.log('üìç Fermate U-Bahn ricevute: ' + uBahnStations.length);
        console.log('üìç Fermate combinate: ' + allStations.length);
        
        // Filtra solo fermate nell'area di Berlino (bbox approssimativo)
        const berlinStations = allStations.filter(station => 
            station.lat >= 52.3 && station.lat <= 52.7 &&
            station.lon >= 13.0 && station.lon <= 13.8
        );
        
        console.log('üìç Fermate prima del filtro geografico: ' + allStations.length);
        console.log('üìç Fermate dopo il filtro geografico: ' + berlinStations.length);
        
        // Mostra alcune fermate di esempio per debug
        if (berlinStations.length > 0) {
            console.log('üîç Prime 5 fermate trovate:');
            berlinStations.slice(0, 5).forEach((station, index) => {
                console.log('  ' + (index + 1) + '. ' + station.name + ' (' + station.type + ') - ' + station.district);
            });
        }
        
        allStations = berlinStations;
        
        console.log('üéØ Fermate totali nell\'area di Berlino: ' + allStations.length);
        
        // Carica le fermate sulla mappa
        loadStationsOnMap(allStations);
        
    } catch (error) {
        console.error('‚ùå Errore inizializzazione fermate:', error);
        
        // Fallback di emergenza: solo fermate principali
        const emergencyStations = [
            { name: "Hauptbahnhof", lat: 52.5251, lon: 13.3694, type: "s-bahn", lines: "S3, S5, S7, S9", district: "Mitte" },
            { name: "Alexanderplatz", lat: 52.5219, lon: 13.4132, type: "both", lines: "S3, S5, S7, S9, U2, U5, U8", district: "Alexanderplatz" },
            { name: "Potsdamer Platz", lat: 52.5096, lon: 13.3758, type: "both", lines: "S1, S2, S25, U2", district: "Mitte" },
            { name: "Zoologischer Garten", lat: 52.5075, lon: 13.3340, type: "both", lines: "S3, S5, S7, S9, U2, U9", district: "Charlottenburg" }
        ];
        
        allStations = emergencyStations;
        loadStationsOnMap(emergencyStations);
        console.log('‚ö†Ô∏è Utilizzando fermate di emergenza');
    }
}

// Layer mappa base (per poterlo nascondere/mostrare)
const baseMapLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
});

// Aggiungi il layer base alla mappa inizialmente
baseMapLayer.addTo(map);
// PASSO 5: Gestisci lo sfondo quando la mappa base √® nascosta
map.on('overlayremove', function(e) {
    if (e.layer === baseMapLayer) {
        map.getContainer().classList.add('no-base-map');
    }
});

map.on('overlayadd', function(e) {
    if (e.layer === baseMapLayer) {
        map.getContainer().classList.remove('no-base-map');
    }
});
const overlayMaps = {
    "üèòÔ∏è Mostra Quartieri": districtLayerGroup,
    "üöá Fermate Metro": stationLayer,
    "üó∫Ô∏è Mappa Citt√†": baseMapLayer
};

const layerControl = L.control.layers(null, overlayMaps, {
    position: 'topright',
    collapsed: true    
}).addTo(map);
// Gestione layer con fermate metro
map.on('overlayadd', function(e) {
    if (e.layer === baseMapLayer) {
        map.getContainer().classList.remove('no-base-map', 'stations-only');
        console.log('üó∫Ô∏è Mappa citt√† attivata');
    }
    
    if (e.layer === stationLayer) {
        console.log('üöá Fermate metro attivate');
        if (!map.hasLayer(baseMapLayer)) {
            map.getContainer().classList.add('stations-only');
            map.getContainer().classList.remove('no-base-map');
        }
    }
});

map.on('overlayremove', function(e) {
    if (e.layer === baseMapLayer) {
        console.log('üó∫Ô∏è Mappa citt√† disattivata');
        if (map.hasLayer(stationLayer)) {
            map.getContainer().classList.add('stations-only');
        } else {
            map.getContainer().classList.add('no-base-map');
        }
    }
    
    if (e.layer === stationLayer) {
        console.log('üöá Fermate metro disattivate');
        map.getContainer().classList.remove('stations-only');
        if (!map.hasLayer(baseMapLayer)) {
            map.getContainer().classList.add('no-base-map');
        }
    }
});
map.on('overlayadd', function(e) {
    if (e.layer === baseMapLayer) {
        map.getContainer().classList.remove('no-base-map', 'stations-only');
        console.log('üó∫Ô∏è Mappa citt√† attivata');
    }
    
    if (e.layer === stationLayer) {
        console.log('üöá Fermate metro attivate');
        if (!map.hasLayer(baseMapLayer)) {
            map.getContainer().classList.add('stations-only');
            map.getContainer().classList.remove('no-base-map');
        }
    }
});

map.on('overlayremove', function(e) {
    if (e.layer === baseMapLayer) {
        console.log('üó∫Ô∏è Mappa citt√† disattivata');
        if (map.hasLayer(stationLayer)) {
            map.getContainer().classList.add('stations-only');
        } else {
            map.getContainer().classList.add('no-base-map');
        }
    }
    
    if (e.layer === stationLayer) {
        console.log('üöá Fermate metro disattivate');
        map.getContainer().classList.remove('stations-only');
        if (!map.hasLayer(baseMapLayer)) {
            map.getContainer().classList.add('no-base-map');
        }
    }
});
            // Aggiungi un titolo personalizzato al controllo
setTimeout(() => {
    const layerControlDiv = document.querySelector('.leaflet-control-layers');
    if (layerControlDiv) {
        const title = document.createElement('div');
       // title.innerHTML = '<strong style="color: var(--primary-color); display: block; margin-bottom: 12px; text-align: center; font-size: 1em; border-bottom: 1px solid rgba(102, 126, 234, 0.2); padding-bottom: 8px;">üéõÔ∏è Controlli Mappa</strong>';
       // layerControlDiv.insertBefore(title, layerControlDiv.firstChild);
    }
}, 100);

            const markers = {};
            let userLocationMarker = null;
let watchId = null;
let isTrackingLocation = false;
            const itineraryPaths = {}; // Per memorizzare i percorsi giornalieri
            let currentView = 'places';
            let currentFilters = ['all']; // Array per filtri multipli
            let currentDistrict = null; // Quartiere attualmente selezionato
            let searchTerm = '';
            let isItineraryExpanded = true; // Stato espansione pannello itinerario

            const listContainer = document.getElementById('list-container');
            const detailsPanel = document.getElementById('details-panel');
            const searchBar = document.getElementById('search-bar');
            const itineraryInfo = document.getElementById('itinerary-info');
            const itineraryToggleBtn = document.getElementById('itinerary-toggle-btn');

            // Funzione per trovare un luogo nei dati (migliorata per il debug)
            function findPlaceInData(placeName) {
                const allPlaces = [...data['hotel'], ...data['food-budget'], ...data['food-mid'], ...data['food-luxury'], ...data['attractions']];
                
                // Prima prova match esatto
                let found = allPlaces.find(place => place.name === placeName);
                
                if (!found) {
                    // Prova match ignorando case e spazi extra
                    found = allPlaces.find(place => 
                        place.name.toLowerCase().trim() === placeName.toLowerCase().trim()
                    );
                }
                
                if (!found) {
                    console.log(`‚ö†Ô∏è Luogo non trovato: "${placeName}"`);
                    console.log('Luoghi disponibili simili:', allPlaces
                        .filter(place => place.name.toLowerCase().includes(placeName.toLowerCase().substring(0, 10)))
                        .map(place => place.name)
                    );
                }
                
                return found;
            }

            // Funzione per disegnare il percorso di un giorno
            function drawItineraryPath(dayId) {
                // Rimuovi percorsi esistenti
                clearItineraryPaths();
                
                const itinerary = detailedItineraries[dayId];
                if (!itinerary) return;
                
                const coordinates = [];
                const validPlaces = [];
                
                // Raccogli le coordinate dei luoghi dell'itinerario
itinerary.places.forEach((place, index) => {
    const foundPlace = findPlaceInData(place.name);
    if (foundPlace && foundPlace.lat && foundPlace.lon) {
        coordinates.push([foundPlace.lat, foundPlace.lon]);
        validPlaces.push({...place, ...foundPlace});
        console.log(`‚úÖ Tappa ${index + 1}: ${place.name} trovato`);
    } else {
        console.log(`‚ùå Tappa ${index + 1}: ${place.name} NON TROVATO nei dati`);
    }
});
                
                if (coordinates.length > 1) {
                    // Crea la linea tratteggiata per il percorso
                    const pathLine = L.polyline(coordinates, {
                        color: itinerary.color,
                        weight: 4,
                        opacity: 0.8,
                        dashArray: '10, 10',
                        lineCap: 'round',
                        lineJoin: 'round'
                    }).addTo(map);
                    
                   // Aggiungi marker numerati per l'ordine
validPlaces.forEach((place, index) => {
    const numberIcon = L.divIcon({
        className: 'itinerary-number',
        html: `<div style="
            background-color: ${itinerary.color};
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        ">${index + 1}</div>`,
        iconSize: [36, 36],
        iconAnchor: [18, 18]
    });
    
    const numberMarker = L.marker([place.lat, place.lon], {
        icon: numberIcon,
        zIndexOffset: 1000
    }).addTo(map);
    
    // Debug per vedere ogni marker creato
    console.log(`üîπ Creato marker ${index + 1} per ${place.name} alle coordinate [${place.lat}, ${place.lon}]`);
    
    // Popup con info dettagliate
    let typeText = '';
    if (place.type === 'lunch') typeText = 'üçΩÔ∏è Pranzo';
    else if (place.type === 'dinner') typeText = 'üçΩÔ∏è Cena';
    else if (place.type === 'evening') typeText = 'üåÉ Dopocena';
    else typeText = 'üèõÔ∏è Visita';
    
    numberMarker.bindPopup(`
        <div style="text-align: center; min-width: 200px;">
            <h4 style="margin: 0 0 5px 0; color: ${itinerary.color};">Tappa ${index + 1}</h4>
            <strong>${place.name}</strong><br>
            <small style="color: #666;">${typeText} - ${place.time}</small><br>
            <em style="font-size: 0.9em;">${place.description}</em>
        </div>
    `);
    
    itineraryPaths[`${dayId}_marker_${index}`] = numberMarker;
    if (index + 1 === 12) {
    console.log(`üî¥ MARKER 12 SPECIFICO:`);
    console.log(`- Nome: ${place.name}`);
    console.log(`- Coordinate: [${place.lat}, ${place.lon}]`);
    console.log(`- Marker creato:`, numberMarker);
    console.log(`- √à stato aggiunto alla mappa:`, numberMarker._map ? 'S√å' : 'NO');
}
});
                    
                    itineraryPaths[`${dayId}_path`] = pathLine;
                    
                    // Centra la mappa sul percorso
                    map.fitBounds(pathLine.getBounds(), {padding: [20, 20]});
                }
            }

            // Funzione per rimuovere tutti i percorsi
            function clearItineraryPaths() {
                Object.values(itineraryPaths).forEach(path => {
                    map.removeLayer(path);
                });
                Object.keys(itineraryPaths).forEach(key => delete itineraryPaths[key]);
            }

            // Funzione per mostrare l'itinerario dettagliato nella lista
            function showDetailedItinerary(dayId) {
                const itinerary = detailedItineraries[dayId];
                if (!itinerary) return;
                
                listContainer.innerHTML = '';
                const ul = document.createElement('ul');
                
                itinerary.places.forEach((place, index) => {
                    const foundPlace = findPlaceInData(place.name);
                    if (!foundPlace) return;
                    
                    const li = document.createElement('li');
                    li.className = foundPlace.category + ' itinerary-item';
                    li.style.borderLeft = `4px solid ${itinerary.color}`;
                    
                    let typeIcon = '';
                    let typeText = '';
                    if (place.type === 'lunch') {
                        typeIcon = 'üçΩÔ∏è';
                        typeText = 'Pranzo';
                    } else if (place.type === 'dinner') {
                        typeIcon = 'üçΩÔ∏è';
                        typeText = 'Cena';
                    } else if (place.type === 'evening') {
                        typeIcon = 'üåÉ';
                        typeText = 'Dopocena';
                    } else {
                        typeIcon = 'üèõÔ∏è';
                        typeText = 'Visita';
                    }
                    
                    const categoryNames = {
                        'food-budget': 'Ristorante ‚Ç¨',
                        'food-mid': 'Ristorante ‚Ç¨‚Ç¨',
                        'food-luxury': 'Ristorante ‚Ç¨‚Ç¨‚Ç¨',
                        'attractions': 'Attrazione'
                    };
                    
                    li.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="
                                background-color: ${itinerary.color};
                                color: white;
                                width: 30px;
                                height: 30px;
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                                font-size: 14px;
                                flex-shrink: 0;
                            ">${index + 1}</div>
                            <div style="flex-grow: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                    <span class="item-name">${foundPlace.name}</span>
                                    <span style="
                                        background: ${itinerary.color};
                                        color: white;
                                        padding: 2px 8px;
                                        border-radius: 12px;
                                        font-size: 0.7em;
                                        font-weight: bold;
                                    ">${place.time}</span>
                                </div>
                                <div class="item-details">
                                    <span class="category-badge ${foundPlace.category}">${categoryNames[foundPlace.category]}</span>
                                    <span style="color: #666; font-size: 0.8em;">${typeIcon} ${typeText}</span>
                                    üìç ${foundPlace.district}
                                </div>
                                <div class="item-description">${foundPlace.description}</div>
                                ${foundPlace.specialty ? `<div style="font-size: 0.8em; color: #0066cc; margin-top: 5px;"><strong>Specialit√†:</strong> ${foundPlace.specialty}</div>` : ''}
                            </div>
                        </div>
                    `;
                    
                    li.addEventListener('click', () => showDetails(foundPlace));
                    ul.appendChild(li);
                });
                
                listContainer.appendChild(ul);
            
            }

            // Crea icone personalizzate per le categorie
            const createCustomIcon = (category) => {
                const isMobile = window.innerWidth <= 768;
                const size = isMobile ? 32 : 28;
                
                let icon, backgroundColor;
                
                if (category === 'hotel') {
                    // Icona speciale per l'hotel
                    return L.divIcon({
                        className: 'hotel-marker-special',
                        html: `<div style="
                            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
                            width: 42px; 
                            height: 42px; 
                            border-radius: 50%; 
                            border: 4px solid white;
                            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.8);
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 22px;
                            animation: hotel-bounce 3s infinite;
                            position: relative;
                            z-index: 1000;
                        ">üè®</div>
                        <div style="
                            position: absolute;
                            top: -12px;
                            left: 50%;
                            transform: translateX(-50%);
                            background: #FF6B6B;
                            color: white;
                            padding: 2px 6px;
                            border-radius: 8px;
                            font-size: 10px;
                            font-weight: bold;
                            white-space: nowrap;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        ">HOTEL</div>`,
                        iconSize: [50, 60],
                        iconAnchor: [25, 30]
                    });
                } else if (category === 'attractions') {
                    icon = 'üèõÔ∏è';
                    backgroundColor = '#f8f9fa';
                } else if (category === 'food-budget') {
                    icon = 'ü•™';
                    backgroundColor = '#00b894'; // Verde per economici
                } else if (category === 'food-mid') {
                    icon = 'ü•™';
                    backgroundColor = '#fdcb6e'; // Giallo per medi
                } else if (category === 'food-luxury') {
                    icon = 'ü•™';
                    backgroundColor = '#e74c3c'; // Rosso per cari
                } else {
                    icon = 'üìç';
                    backgroundColor = '#6c5ce7';
                }
                
                return L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background-color: ${backgroundColor};
                        width: ${size}px; 
                        height: ${size}px; 
                        border-radius: 50%; 
                        border: 3px solid white;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: ${isMobile ? '16px' : '14px'};
                    ">${icon}</div>`,
                    iconSize: [size + 6, size + 6],
                    iconAnchor: [(size + 6) / 2, (size + 6) / 2]
                });
            };

            function showDetails(item) {
                const categoryNames = {
                    'food-budget': 'Ristorante ‚Ç¨ (Economico)',
                    'food-mid': 'Ristorante ‚Ç¨‚Ç¨ (Fascia Media)',
                    'food-luxury': 'Ristorante ‚Ç¨‚Ç¨‚Ç¨ (Lusso)',
                    'attractions': 'Attrazione',
                    'hotel': 'Il Vostro Hotel'
                };
                
                const rankingLabels = {
                    'top': 'Scelta Consigliata',
                    'good': 'Ottima Alternativa',
                    'budget': 'Opzione Conveniente'
                };
                
                let detailsHTML = `
                    <h2>${item.name}</h2>
                    <p class="category">${categoryNames[item.category]} - ${item.district}</p>
                `;
                
                if (item.category === 'hotel') {
                    detailsHTML += `
                        <div style="background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <strong>üè® BASE PERFETTA PER IL VOSTRO VIAGGIO</strong><br>
                            üìç L√ºtzowplatz 17, 10785 Berlino<br>
                            üöá Ottima posizione nel quartiere Tiergarten<br>
                            ‚ú® Punto di partenza ideale per tutti gli itinerari
                        </div>
                    `;
                } else {
                    if (item.ranking) {
                        detailsHTML += `<p><span class="ranking-badge ${item.ranking}">${rankingLabels[item.ranking]}</span></p>`;
                    }
                    
                    if (item.day) {
                        detailsHTML += `<p><span class="category-badge itinerary">Giorno ${item.day}</span></p>`;
                    }
                }
                
                detailsHTML += `<p>${item.description}</p>`;
                
                if (item.specialty) {
                    detailsHTML += `
                        <div class="specialty">
                            <strong>Specialit√†:</strong> ${item.specialty}
                        </div>
                    `;
                }
                
                detailsPanel.innerHTML = detailsHTML;
                
                // Evidenzia il quartiere del luogo selezionato
                highlightDistrict(item.district);
                
                if (item.lat && item.lon) {
                    map.flyTo([item.lat, item.lon], 16);
                    const markerKey = item.category === 'hotel' ? `${item.name}_hotel` : `${item.name}_${item.category}`;
                    const marker = markers[markerKey];
                    if (marker) {
                        marker.openPopup();
                    }
                }
            }

            // Funzione per evidenziare un quartiere
            function highlightDistrict(districtName) {
                // Reset tutti i quartieri al colore normale
                Object.entries(districtLayers).forEach(([name, layer]) => {
                    const district = districts[name];
                    layer.setStyle({
                        color: district.color,
                        fillColor: district.color,
                        fillOpacity: 0.2,
                        weight: 2,
                        opacity: 0.6
                    });
                });
                
                // Evidenzia il quartiere selezionato
                if (districtLayers[districtName]) {
                    const district = districts[districtName];
                    districtLayers[districtName].setStyle({
                        color: district.color,
                        fillColor: district.color,
                        fillOpacity: 0.4,
                        weight: 3,
                        opacity: 0.8
                    });
                }
            }

            function populateList() {
                console.log('populateList called with filters:', currentFilters, 'district:', currentDistrict);
                listContainer.innerHTML = '';
                const ul = document.createElement('ul');
                let itemsToShow = [];
                
                if (currentView === 'districts') {
                    if (currentDistrict) {
                        // Quartiere specifico selezionato
                        itemsToShow = [...data['food-budget'], ...data['food-mid'], ...data['food-luxury'], ...data['attractions']]
                            .filter(item => item.district === currentDistrict);
                        
                        // Applica filtri aggiuntivi SOLO se non √® 'all' E ci sono filtri attivi
                        if (!currentFilters.includes('all') && currentFilters.length > 0) {
                            const categoryFilters = currentFilters.filter(f => 
                                f === 'food-budget' || f === 'food-mid' || f === 'food-luxury' || f === 'attractions'
                            );
                            const dayFilters = currentFilters.filter(f => f.startsWith('day'));
                            
                            if (categoryFilters.length > 0) {
                                itemsToShow = itemsToShow.filter(item => categoryFilters.includes(item.category));
                            }
                            
                            if (dayFilters.length > 0) {
                                const allowedDays = dayFilters.map(f => parseInt(f.replace('day', '')));
                                itemsToShow = itemsToShow.filter(item => item.day && allowedDays.includes(item.day));
                            }
                        }
                    } else {
                        // Mostra lista di quartieri
                        Object.entries(districts).forEach(([name, district]) => {
                            const li = document.createElement('li');
                            li.className = 'district-item';
                            li.style.borderLeft = `4px solid ${district.color}`;
                            
                            const placesInDistrict = [...data['food-budget'], ...data['food-mid'], ...data['food-luxury'], ...data['attractions']]
                                .filter(item => item.district === name);
                            
                            li.innerHTML = `
                                <span class="item-name">üìç ${name}</span>
                                <span class="item-details">
                                    <span class="category-badge" style="background: ${district.color}; color: white;">Quartiere</span>
                                    üèõÔ∏è ${placesInDistrict.filter(item => item.category === 'attractions').length} attrazioni
                                    ü•™ ${placesInDistrict.filter(item => item.category.includes('food')).length} ristoranti
                                </span>
                                <div class="item-description">${district.description}</div>
                            `;
                            
                            li.addEventListener('click', () => {
                                filterByDistrict(name);
                                highlightDistrict(name);
                                
                                // Centra mappa sul quartiere
                                if (districtLayers[name]) {
                                    map.fitBounds(districtLayers[name].getBounds(), {padding: [20, 20]});
                                }
                            });
                            ul.appendChild(li);
                        });
                        
                        listContainer.appendChild(ul);
                     
                        return;
                    }
                } else {
                    // Vista luoghi o itinerario
                    itemsToShow = [...data['food-budget'], ...data['food-mid'], ...data['food-luxury'], ...data['attractions']];
                    
                    // Applica filtro quartiere se selezionato
                    if (currentDistrict) {
                        itemsToShow = itemsToShow.filter(item => item.district === currentDistrict);
                    }
                    
                    // Applica filtri di categoria SOLO se non √® 'all' E ci sono filtri attivi
                    if (!currentFilters.includes('all') && currentFilters.length > 0) {
                        const categoryFilters = currentFilters.filter(f => 
                            f === 'food-budget' || f === 'food-mid' || f === 'food-luxury' || f === 'attractions'
                        );
                        const dayFilters = currentFilters.filter(f => f.startsWith('day'));
                        
                        if (categoryFilters.length > 0) {
                            itemsToShow = itemsToShow.filter(item => categoryFilters.includes(item.category));
                        }
                        
                        if (dayFilters.length > 0) {
                            const allowedDays = dayFilters.map(f => parseInt(f.replace('day', '')));
                            itemsToShow = itemsToShow.filter(item => item.day && allowedDays.includes(item.day));
                        }
                    }
                    
                    // Mostra info itinerario se applicabile
                    const dayFilters = currentFilters.filter(f => f.startsWith('day'));
                    if (currentView === 'itinerary' && dayFilters.length === 1) {
                        const itinerary = detailedItineraries[dayFilters[0]];
                        if (itinerary) {
                            document.getElementById('itinerary-title').innerHTML = itinerary.title;
                            document.getElementById('itinerary-description').innerHTML = `
                                <div style="margin-bottom: 15px;"><strong>Tema del giorno:</strong> ${itinerary.theme}</div>
                                ${itinerary.fullDescription}
                            `;
                            itineraryInfo.classList.add('active');
                            
                            // Disegna il percorso sulla mappa
                            drawItineraryPath(dayFilters[0]);
                            
                            // Mostra l'itinerario dettagliato nella lista
                            if (!currentDistrict && !searchTerm) {
                                showDetailedItinerary(dayFilters[0]);
                                return;
                            }
                        }
                    } else {
                        itineraryInfo.classList.remove('active');
                        clearItineraryPaths();
                    }
                }
                
                // Applica filtro di ricerca
                if (searchTerm) {
                    itemsToShow = itemsToShow.filter(item => 
                        item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.district.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (item.specialty && item.specialty.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                }

                console.log('Items to show after all filters:', itemsToShow.length);

                // Ordina per ranking e poi per nome
                itemsToShow.sort((a, b) => {
                    const rankingOrder = { 'top': 1, 'good': 2, 'budget': 3 };
                    const aRank = rankingOrder[a.ranking] || 4;
                    const bRank = rankingOrder[b.ranking] || 4;
                    
                    if (aRank !== bRank) return aRank - bRank;
                    return a.name.localeCompare(b.name);
                });

                itemsToShow.forEach(item => {
                    const li = document.createElement('li');
                    li.className = item.category;
                    
                    const categoryNames = {
                        'food-budget': 'Ristorante ‚Ç¨',
                        'food-mid': 'Ristorante ‚Ç¨‚Ç¨',
                        'food-luxury': 'Ristorante ‚Ç¨‚Ç¨‚Ç¨',
                        'attractions': 'Attrazione'
                    };

                    const rankingLabels = {
                        'top': 'Top',
                        'good': 'Buono',
                        'budget': 'Economico'
                    };

                    let badges = `<span class="category-badge ${item.category}">${categoryNames[item.category]}</span>`;
                    
                    if (item.ranking) {
                        badges += ` <span class="ranking-badge ${item.ranking}">${rankingLabels[item.ranking]}</span>`;
                    }
                    
                    if (item.day && currentView === 'places') {
                        badges += ` <span class="category-badge itinerary">Giorno ${item.day}</span>`;
                    }

                    li.innerHTML = `
                        <span class="item-name">${item.name}</span>
                        <span class="item-details">
                            ${badges}
                            üìç ${item.district}
                        </span>
                        <div class="item-description">${item.description}</div>
                    `;
                    
                    li.addEventListener('click', () => showDetails(item));
                    ul.appendChild(li);
                });
                
                listContainer.appendChild(ul);
              
            }

        function updateMarkers() {
    console.log('updateMarkers called. Current view:', currentView, 'Current district:', currentDistrict, 'Current filters:', currentFilters);
    
    // Rimuovi tutti i marker esistenti
    Object.entries(markers).forEach(([key, marker]) => {
        map.removeLayer(marker);
        delete markers[key];
    });
    
    // ===== AGGIUNGI SEMPRE L'HOTEL PRIMA DI TUTTO =====
    const hotelData = data.hotel[0];
    if (hotelData && hotelData.lat && hotelData.lon) {
        const hotelMarker = L.marker([hotelData.lat, hotelData.lon], {
            icon: createCustomIcon('hotel'),
            zIndexOffset: 2000 // Sempre in primo piano
        }).addTo(map);
        
        hotelMarker.bindPopup(`
            <div style="text-align: center; min-width: 250px;">
                <h3 style="margin: 0 0 10px 0; color: #FF6B6B;">üè® IL VOSTRO HOTEL</h3>
                <strong>Hotel Berlin, Berlin<br>Radisson Individuals</strong><br>
                <small style="color: #666;">üìç L√ºtzowplatz 17, 10785 Berlino</small><br>
                <em style="font-size: 0.9em; color: #555;">Base perfetta per esplorare Berlino</em><br>
                <div style="margin-top: 10px; padding: 8px; background: #f0f0f0; border-radius: 5px;">
                    <strong>üöá Posizione strategica nel quartiere Tiergarten</strong>
                </div>
            </div>
        `);
        
        hotelMarker.on('click', () => showDetails(hotelData));
        markers[`hotel_marker`] = hotelMarker;
        console.log('‚úÖ Hotel marker added at coordinates:', hotelData.lat, hotelData.lon);
        console.log('‚úÖ Hotel marker object:', hotelMarker);
    } else {
        console.log('‚ùå Hotel data missing or incomplete:', hotelData);
    }
    
    // Resto del codice per gli altri marker...
    let itemsToShow = [];
    
    if (currentView === 'districts' && !currentDistrict) {
        console.log('Districts view without selected district - showing only hotel');
      
        return;
    }
                
                // Parti da tutti gli elementi (escluso hotel che √® gi√† aggiunto)
                itemsToShow = [...data['food-budget'], ...data['food-mid'], ...data['food-luxury'], ...data['attractions']];
                console.log('Starting with', itemsToShow.length, 'total items');
                
                // Applica filtro quartiere se selezionato
                if (currentDistrict) {
                    itemsToShow = itemsToShow.filter(item => item.district === currentDistrict);
                    console.log('After district filter:', itemsToShow.length, 'items');
                }
                
                // Applica filtri di categoria SOLO se non √® 'all' E ci sono filtri attivi
                if (!currentFilters.includes('all') && currentFilters.length > 0) {
                    console.log('Applying category filters');
                    const categoryFilters = currentFilters.filter(f => 
                        f === 'food-budget' || f === 'food-mid' || f === 'food-luxury' || f === 'attractions'
                    );
                    const dayFilters = currentFilters.filter(f => f.startsWith('day'));
                    
                    // Filtro per categoria (solo se ci sono filtri di categoria)
                    if (categoryFilters.length > 0) {
                        itemsToShow = itemsToShow.filter(item => categoryFilters.includes(item.category));
                        console.log('After category filter:', itemsToShow.length, 'items');
                    }
                    
                    // Filtro per giorno (solo se ci sono filtri di giorno)
                    if (dayFilters.length > 0) {
                        const allowedDays = dayFilters.map(f => parseInt(f.replace('day', '')));
                        itemsToShow = itemsToShow.filter(item => item.day && allowedDays.includes(item.day));
                        console.log('After day filter:', itemsToShow.length, 'items');
                    }
                } else {
                    console.log('Using all items (no specific filters)');
                }
                
                // Applica filtro di ricerca
                if (searchTerm) {
                    itemsToShow = itemsToShow.filter(item => 
                        item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.district.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (item.specialty && item.specialty.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                    console.log('After search filter:', itemsToShow.length, 'items');
                }
                
                console.log('Final items to show:', itemsToShow.length);
                
                itemsToShow.forEach(item => {
                    if (item.lat && item.lon) {
                        const marker = L.marker([item.lat, item.lon], {
                            icon: createCustomIcon(item.category)
                        }).addTo(map);
                        
                        marker.bindPopup(`<b>${item.name}</b><br>${item.district}<br><small>${item.category === 'attractions' ? 'Attrazione' : 'Ristorante'}</small>`);
                        marker.on('click', () => showDetails(item));
                        markers[`${item.name}_${item.category}`] = marker;
                    }
                });
                
                console.log('Added', Object.keys(markers).length, 'markers to map (including hotel)');
              
            }

           

            // Funzione per filtrare per quartiere
            function filterByDistrict(districtName) {
                currentDistrict = districtName;
                populateList();
                updateMarkers();
                
                // Aggiorna il pannello dettagli con info del quartiere
                const district = districts[districtName];
                if (district) {
                    const activeFiltersText = currentFilters.includes('all') ? 'Tutti i luoghi' : 
                        currentFilters.map(f => {
                            if (f === 'food-budget') return 'Ristoranti ‚Ç¨';
                            if (f === 'food-mid') return 'Ristoranti ‚Ç¨‚Ç¨';
                            if (f === 'food-luxury') return 'Ristoranti ‚Ç¨‚Ç¨‚Ç¨';
                            if (f === 'attractions') return 'Attrazioni';
                            if (f.startsWith('day')) return `Giorno ${f.replace('day', '')}`;
                            return f;
                        }).join(', ');
                        
                    detailsPanel.innerHTML = `
                        <h2>üìç ${districtName}</h2>
                        <p class="category">Quartiere - ${district.description}</p>
                        <p><strong>Filtri attivi:</strong> ${activeFiltersText}</p>
                        <button onclick="resetDistrictView()" style="
                            background: var(--primary-color);
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 20px;
                            cursor: pointer;
                            font-family: 'Poppins', sans-serif;
                            font-size: 0.9em;
                            margin-top: 10px;
                        ">‚Üê Torna ai Quartieri</button>
                        <p style="margin-top: 10px;"><strong>Usa i filtri sopra per combinare pi√π categorie (es: Attrazioni + Ristoranti ‚Ç¨)</strong></p>
                    `;
                }
            }

            // Funzione per tornare alla vista quartieri
            function resetDistrictView() {
                currentDistrict = null;
                currentFilters = ['all'];
                updateFilterButtons();
                
                // Reset evidenziazione quartieri
                Object.entries(districtLayers).forEach(([name, layer]) => {
                    const district = districts[name];
                    layer.setStyle({
                        color: district.color,
                        fillColor: district.color,
                        fillOpacity: 0.2,
                        weight: 2,
                        opacity: 0.6
                    });
                });
                
                detailsPanel.innerHTML = `
                    <h2>üèòÔ∏è Quartieri di Berlino</h2>
                    <p>Esplora la citt√† per quartieri. Clicca su un quartiere nella lista o sulla mappa per vedere tutti i luoghi di quel quartiere.</p>
                    <p><strong>Suggerimento:</strong> Dopo aver selezionato un quartiere, usa i filtri per combinare pi√π categorie (es: Attrazioni + Ristoranti ‚Ç¨).</p>
                `;
                
                // Riporta la mappa alla vista generale
                map.setView([52.5200, 13.4050], 12);
                
                populateList();
                updateMarkers();
            }

            // Funzione per aggiornare l'aspetto dei bottoni filtro
            function updateFilterButtons() {
                console.log('updateFilterButtons called with:', currentFilters);
                
                document.querySelectorAll('#filter-nav button').forEach(btn => {
                    const filterId = btn.id.replace('btn-', '');
                    if (currentFilters.includes(filterId)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // Aggiorna indicatore filtri attivi
                const indicator = document.getElementById('active-filters-indicator');
                if (currentFilters.includes('all')) {
                    indicator.textContent = currentDistrict ? `${currentDistrict}: Tutti i luoghi` : 'Filtri: Tutti i luoghi';
                    indicator.classList.remove('show');
                } else if (currentFilters.length > 1) {
                    const filterNames = currentFilters.map(f => {
                        if (f === 'food-budget') return 'Ristoranti ‚Ç¨';
                        if (f === 'food-mid') return 'Ristoranti ‚Ç¨‚Ç¨';
                        if (f === 'food-luxury') return 'Ristoranti ‚Ç¨‚Ç¨‚Ç¨';
                        if (f === 'attractions') return 'Attrazioni';
                        if (f.startsWith('day')) return `Giorno ${f.replace('day', '')}`;
                        return f;
                    }).join(' + ');
                    
                    indicator.textContent = currentDistrict ? `${currentDistrict}: ${filterNames}` : `Filtri: ${filterNames}`;
                    indicator.classList.add('show');
                } else if (currentFilters.length === 1) {
                    const filterName = currentFilters.map(f => {
                        if (f === 'food-budget') return 'Ristoranti ‚Ç¨';
                        if (f === 'food-mid') return 'Ristoranti ‚Ç¨‚Ç¨';
                        if (f === 'food-luxury') return 'Ristoranti ‚Ç¨‚Ç¨‚Ç¨';
                        if (f === 'attractions') return 'Attrazioni';
                        if (f.startsWith('day')) return `Giorno ${f.replace('day', '')}`;
                        return f;
                    })[0];
                    
                    // Per la vista itinerario, mostra solo il giorno senza "Filtri:"
                    if (currentView === 'itinerary' && currentFilters[0].startsWith('day')) {
                        indicator.textContent = filterName;
                    } else {
                        indicator.textContent = currentDistrict ? `${currentDistrict}: ${filterName}` : `Filtri: ${filterName}`;
                    }
                    
                    if (currentView === 'itinerary' && currentFilters[0].startsWith('day')) {
                        indicator.classList.add('show');
                    } else if (currentFilters[0] !== 'all') {
                        indicator.classList.add('show');
                    } else {
                        indicator.classList.remove('show');
                    }
                } else {
                    indicator.classList.remove('show');
                }
            }

            // Funzione per aggiungere/rimuovere un filtro
            function toggleFilter(filterId) {
                console.log('Toggling filter:', filterId, 'Current filters:', currentFilters);
                
                // Se siamo in vista itinerario e selezioniamo un giorno, pulisci i percorsi esistenti
                if (currentView === 'itinerary' && filterId.startsWith('day')) {
                    clearItineraryPaths();
                }
                
                if (filterId === 'all') {
                    // Reset a tutto
                    currentFilters = ['all'];
                    clearItineraryPaths();
                } else {
                    // Rimuovi 'all' se presente
                    if (currentFilters.includes('all')) {
                        currentFilters = [];
                    }
                    
                    if (currentFilters.includes(filterId)) {
                        // Rimuovi il filtro se gi√† presente
                        currentFilters = currentFilters.filter(f => f !== filterId);
                    } else {
                        // Per la vista itinerario, permetti solo un giorno alla volta
                        if (currentView === 'itinerary' && filterId.startsWith('day')) {
                            currentFilters = currentFilters.filter(f => !f.startsWith('day'));
                        }
                        // Aggiungi il filtro
                        currentFilters.push(filterId);
                    }
                    
                    // Se non ci sono filtri, rimetti 'all'
                    if (currentFilters.length === 0) {
                        currentFilters = ['all'];
                    }
                }
                
                console.log('New filters:', currentFilters);
                updateFilterButtons();
                populateList();
                updateMarkers();
            }

            // Funzione per gestire il toggle del pannello itinerario
            function toggleItineraryInfo() {
                isItineraryExpanded = !isItineraryExpanded;
                const itineraryInfo = document.getElementById('itinerary-info');
                const toggleBtn = document.getElementById('itinerary-toggle-btn');
                
                if (isItineraryExpanded) {
                    itineraryInfo.classList.remove('collapsed');
                    toggleBtn.innerHTML = '‚ñº';
                    toggleBtn.title = 'Comprimi pannello';
                } else {
                    itineraryInfo.classList.add('collapsed');
                    toggleBtn.innerHTML = '‚ñ≤';
                    toggleBtn.title = 'Espandi pannello';
                }
            }

            // Event listener per espandere cliccando sulla zona compressa
            function setupItineraryClickHandler() {
                itineraryInfo.addEventListener('click', (e) => {
                    // Espandi solo se √® compresso e non si √® cliccato sul pulsante
                    if (!isItineraryExpanded && !e.target.classList.contains('itinerary-toggle-btn')) {
                        toggleItineraryInfo();
                    }
                });
            }

            // Event listeners per navigazione principale
            document.querySelectorAll('#main-nav button').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('#main-nav button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    const previousView = currentView;
                    currentView = e.target.id.replace('btn-', '');
                    
                    // Pulisci i percorsi quando cambi vista
                    if (previousView === 'itinerary' || currentView !== 'itinerary') {
                        clearItineraryPaths();
                    }
                    
                    // Reset filtri quando cambi vista
                    if (currentView === 'itinerary') {
                        currentFilters = ['day1'];
                        currentDistrict = null;
                        // Mostra subito il primo giorno
                        setTimeout(() => {
                            const itinerary = detailedItineraries['day1'];
                            if (itinerary) {
                                document.getElementById('itinerary-title').innerHTML = itinerary.title;
                                document.getElementById('itinerary-description').innerHTML = `
                                    <div style="margin-bottom: 15px;"><strong>Tema del giorno:</strong> ${itinerary.theme}</div>
                                    ${itinerary.fullDescription}
                                `;
                                itineraryInfo.classList.add('active');
                                drawItineraryPath('day1');
                            }
                        }, 100);
                    } else if (currentView === 'districts') {
                        // Mantieni i filtri ma resetta il quartiere se non in vista quartieri
                        if (!currentDistrict) {
                            currentFilters = ['all'];
                        }
                        
                        // Reset evidenziazione quartieri se non ce n'√® uno selezionato
                        if (!currentDistrict) {
                            Object.entries(districtLayers).forEach(([name, layer]) => {
                                const district = districts[name];
                                layer.setStyle({
                                    color: district.color,
                                    fillColor: district.color,
                                    fillOpacity: 0.2,
                                    weight: 2,
                                    opacity: 0.6
                                });
                            });
                            
                            // Mostra info quartieri nel pannello dettagli
                            detailsPanel.innerHTML = `
                                <h2>üèòÔ∏è Quartieri di Berlino</h2>
                                <p>Esplora la citt√† per quartieri. Clicca su un quartiere nella lista o sulla mappa per vedere tutti i luoghi di quel quartiere.</p>
                                <p><strong>Suggerimento:</strong> Dopo aver selezionato un quartiere, usa i filtri per combinare pi√π categorie.</p>
                            `;
                        }
                    } else {
                        // Vista luoghi - mantieni filtri ma resetta quartiere
                        currentDistrict = null;
                        if (currentFilters.length === 0 || (currentFilters.length === 1 && currentFilters[0].startsWith('day'))) {
                            currentFilters = ['all'];
                        }
                        itineraryInfo.classList.remove('active');
                        
                        // Reset evidenziazione quartieri se venivamo dalla vista quartieri
                        if (previousView === 'districts') {
                            Object.entries(districtLayers).forEach(([name, layer]) => {
                                const district = districts[name];
                                layer.setStyle({
                                    color: district.color,
                                    fillColor: district.color,
                                    fillOpacity: 0.2,
                                    weight: 2,
                                    opacity: 0.6
                                });
                            });
                        }
                    }
                    
                    updateFilterButtons();
                    populateList();
                    updateMarkers();
                });
            });

            // Event listeners per filtri (ora con toggle multiplo)
            document.querySelectorAll('#filter-nav button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const filterId = e.target.id.replace('btn-', '');
                    toggleFilter(filterId);
                });
            });

            searchBar.addEventListener('input', (e) => {
                searchTerm = e.target.value;
                populateList();
                updateMarkers();
                
                // Mantieni i percorsi visibili durante la ricerca in vista itinerario
                if (currentView === 'itinerary' && currentFilters.some(f => f.startsWith('day'))) {
                    const dayFilter = currentFilters.find(f => f.startsWith('day'));
                    if (dayFilter && !searchTerm) {
                        // Rimostra il percorso se la ricerca √® vuota
                        setTimeout(() => {
                            drawItineraryPath(dayFilter);
                        }, 100);
                    }
                }
            });

            // Gestione cambio orientamento mobile
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    map.invalidateSize();
                    updateMarkers();
                }, 500);
            });

            // Gestione resize finestra
            window.addEventListener('resize', () => {
                map.invalidateSize();
                updateMarkers();
            });

            // Inizializzazione
            console.log('Initializing with filters:', currentFilters);
            
          // Pannello dettagli vuoto all'avvio
detailsPanel.innerHTML = `
    <div style="text-align: center; color: #666; padding: 20px;">
        <p>Seleziona un luogo dalla lista per vedere i dettagli</p>
    </div>
`;
            
            updateFilterButtons();
            populateList();
            updateMarkers();
            setupItineraryClickHandler(); // Configura i click handler per il pannello itinerario
            // Inizializza le fermate dall'API Overpass
initializeStations();
            // Se siamo in vista itinerario e c'√® un giorno selezionato, mostra subito le info
            if (currentView === 'itinerary' && currentFilters.some(f => f.startsWith('day'))) {
                const dayFilter = currentFilters.find(f => f.startsWith('day'));
                if (dayFilter) {
                    const itinerary = detailedItineraries[dayFilter];
                    if (itinerary) {
                        document.getElementById('itinerary-title').innerHTML = itinerary.title;
                        document.getElementById('itinerary-description').innerHTML = `
                            <div style="margin-bottom: 15px;"><strong>Tema del giorno:</strong> ${itinerary.theme}</div>
                            ${itinerary.fullDescription}
                        `;
                        itineraryInfo.classList.add('active');
                        setTimeout(() => drawItineraryPath(dayFilter), 100);
                    }
                }
            }
// Funzioni per la geolocalizzazione
function toggleLocation() {
    const locationBtn = document.getElementById('location-btn');
    
    if (!isTrackingLocation) {
        startLocationTracking();
    } else {
        stopLocationTracking();
    }
}

function startLocationTracking() {
    const locationBtn = document.getElementById('location-btn');
    
    if (!navigator.geolocation) {
        alert('La geolocalizzazione non √® supportata da questo browser');
        return;
    }
    
    locationBtn.classList.add('active');
    locationBtn.innerHTML = 'üéØ';
    locationBtn.title = 'Disattiva tracciamento';
    isTrackingLocation = true;
    
    // Opzioni per la geolocalizzazione
    const options = {
        enableHighAccuracy: true, // Usa GPS se disponibile
        timeout: 10000, // 10 secondi di timeout
        maximumAge: 60000 // Cache per 1 minuto
    };
    
    // Ottieni posizione iniziale
    navigator.geolocation.getCurrentPosition(
        showPosition,
        showError,
        options
    );
    
    // Inizia il tracciamento continuo
    watchId = navigator.geolocation.watchPosition(
        showPosition,
        showError,
        options
    );
    
    console.log('üéØ Tracciamento posizione iniziato');
}

function stopLocationTracking() {
    const locationBtn = document.getElementById('location-btn');
    
    locationBtn.classList.remove('active');
    locationBtn.innerHTML = 'üìç';
    locationBtn.title = 'La mia posizione';
    isTrackingLocation = false;
    
    if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }
    
    if (userLocationMarker) {
        map.removeLayer(userLocationMarker);
        userLocationMarker = null;
    }
    
    console.log('üéØ Tracciamento posizione fermato');
}

function showPosition(position) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    const accuracy = position.coords.accuracy;
    
    console.log(`üéØ Posizione aggiornata: [${lat}, ${lon}] ¬±${accuracy}m`);
    
    // Rimuovi marker precedente se esiste
    if (userLocationMarker) {
        map.removeLayer(userLocationMarker);
    }
    
    // Crea icona personalizzata per la posizione utente
    const userIcon = L.divIcon({
        className: 'user-location-marker',
        html: `
        <div style="
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.6);
            position: relative;
            animation: pulse 2s infinite;
        "></div>
        <div style="
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        ">TU</div>`,
        iconSize: [26, 26],
        iconAnchor: [13, 13]
    });
    
    // Aggiungi marker della posizione utente
    userLocationMarker = L.marker([lat, lon], {
        icon: userIcon,
        zIndexOffset: 3000 // Sempre sopra gli altri marker
    }).addTo(map);
    
    // Popup con informazioni sulla posizione
    userLocationMarker.bindPopup(`
        <div style="text-align: center; min-width: 200px;">
            <h3 style="margin: 0 0 10px 0; color: #667eea;">üìç LA TUA POSIZIONE</h3>
            <strong>Coordinate:</strong><br>
            <small>${lat.toFixed(6)}, ${lon.toFixed(6)}</small><br>
            <strong>Precisione:</strong> ¬±${accuracy}m<br>
            <small style="color: #666;">Aggiornato: ${new Date().toLocaleTimeString('it-IT')}</small>
        </div>
    `);
    
    // Se √® il primo posizionamento, centra la mappa
    if (!map.getBounds().contains([lat, lon])) {
        map.setView([lat, lon], 16);
    }
}

function showError(error) {
    const locationBtn = document.getElementById('location-btn');
    let message = '';
    
    switch(error.code) {
        case error.PERMISSION_DENIED:
            message = "Geolocalizzazione negata dall'utente. Abilita la posizione nelle impostazioni del browser.";
            break;
        case error.POSITION_UNAVAILABLE:
            message = "Informazioni sulla posizione non disponibili.";
            break;
        case error.TIMEOUT:
            message = "Timeout nella richiesta di geolocalizzazione.";
            break;
        default:
            message = "Errore sconosciuto nella geolocalizzazione.";
            break;
    }
    
    console.error('‚ùå Errore geolocalizzazione:', message);
    alert(`Errore: ${message}`);
    
    stopLocationTracking();
}
            // Esponi funzioni globalmente per i bottoni
            window.resetDistrictView = resetDistrictView;
            window.toggleItineraryInfo = toggleItineraryInfo;
            window.toggleLocation = toggleLocation;
            // ===== FUNZIONALIT√Ä SIDEBAR TOGGLE =====
            let isSidebarVisible = false;
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle');

            function toggleSidebar() {
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // Logica mobile: overlay toggle
                    isSidebarVisible = !isSidebarVisible;
                    
                    if (isSidebarVisible) {
                        sidebar.classList.add('show');
                        sidebar.classList.remove('collapsed');
                        toggleBtn.innerHTML = '‚úï';
                        toggleBtn.classList.add('active');
                    } else {
                        sidebar.classList.remove('show');
                        sidebar.classList.add('collapsed');
                        toggleBtn.innerHTML = '‚ò∞';
                        toggleBtn.classList.remove('active');
                    }
                } else {
                    // Logica desktop: hide/show sidebar
                    sidebar.classList.toggle('collapsed');
                    
                    if (sidebar.classList.contains('collapsed')) {
                        toggleBtn.innerHTML = '‚ò∞';
                        toggleBtn.classList.remove('active');
                    } else {
                        toggleBtn.innerHTML = '‚úï';
                        toggleBtn.classList.add('active');
                    }
                }
                
                // Ridimensiona la mappa dopo il toggle
                setTimeout(() => {
                    map.invalidateSize();
                }, 300);
            }

            // Gestione resize finestra per sidebar
            window.addEventListener('resize', () => {
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // Su mobile: mostra il toggle button
                    if (toggleBtn) {
                        toggleBtn.style.display = 'flex';
                    }
                    if (!isSidebarVisible) {
                        sidebar.classList.add('collapsed');
                        sidebar.classList.remove('show');
                    }
                } else {
                    // Su desktop: nascondi il toggle button e ripristina sidebar
                    if (toggleBtn) {
                        toggleBtn.style.display = 'none';
                    }
                    sidebar.classList.remove('collapsed', 'show');
                    isSidebarVisible = false;
                }
                
                map.invalidateSize();
            });

            // Inizializzazione stato mobile
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                sidebar.classList.add('collapsed');
                if (toggleBtn) {
                    toggleBtn.style.display = 'flex';
                }
            } else {
                if (toggleBtn) {
                    toggleBtn.style.display = 'none';
                }
            }

            // Esponi la funzione globalmente
            window.toggleSidebar = toggleSidebar;
            // ===== MIGLIORAMENTI LAYER CONTROL =====
            
            // Migliora l'aspetto del layer control dopo che √® stato creato
            setTimeout(() => {
                const layerControlDiv = document.querySelector('.leaflet-control-layers');
                if (layerControlDiv) {
                    // Aggiungi classe personalizzata
                    layerControlDiv.classList.add('enhanced-layer-control');
                    
                    // Migliora l'effetto hover
                    const toggle = layerControlDiv.querySelector('.leaflet-control-layers-toggle');
                    if (toggle) {
                        toggle.addEventListener('mouseenter', function() {
                            this.style.transform = 'scale(1.1)';
                            this.style.background = 'var(--primary-color)';
                        });
                        
                        toggle.addEventListener('mouseleave', function() {
                            this.style.transform = 'scale(1)';
                            this.style.background = 'rgba(255,255,255,0.95)';
                        });
                    }
                }
            }, 1000);
            
            // Funzione per controllare programmaticamente il layer control
            function toggleLayerControl() {
                const layerControlDiv = document.querySelector('.leaflet-control-layers');
                if (layerControlDiv) {
                    const isExpanded = layerControlDiv.classList.contains('leaflet-control-layers-expanded');
                    
                    if (isExpanded) {
                        // Simula click per chiudere
                        const toggle = layerControlDiv.querySelector('.leaflet-control-layers-toggle');
                        if (toggle) toggle.click();
                    } else {
                        // Simula click per aprire
                        const toggle = layerControlDiv.querySelector('.leaflet-control-layers-toggle');
                        if (toggle) toggle.click();
                    }
                }
            }
            
            // Esponi la funzione globalmente
            window.toggleLayerControl = toggleLayerControl;
        }
    </script>
</body>
</html>
